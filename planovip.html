<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Plano de Aula Mo√ßambicano</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Times New Roman", Times, serif;
      font-size: 14px;
      background: #eef2f5;
      margin: 0;
      padding: 10px;
    }
    html, body {
      -webkit-touch-callout: none;
      -webkit-user-drag: none;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      background: #fff;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Indicador de fases */
    .fases-indicador {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 0;
      border-bottom: 2px solid #e0e7ff;
    }
    
    .fase-item {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      font-weight: bold;
      color: #888;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .fase-item.ativo {
      color: #2b5dab;
      border-bottom-color: #2b5dab;
    }
    
    .fase-numero {
      display: inline-block;
      width: 28px;
      height: 28px;
      line-height: 28px;
      border-radius: 50%;
      background: #e0e7ff;
      color: #2b5dab;
      margin-right: 8px;
      font-size: 14px;
    }
    
    .fase-item.ativo .fase-numero {
      background: #2b5dab;
      color: white;
    }
    
    h1 {
      font-size: 22px;
      text-align: center;
      color: #2b5dab;
      margin: 5px 0 0;
    }
    h3 {
      font-size: 16px;
      text-align: center;
      color: #444;
      margin: 0 0 20px;
    }
    label {
      font-weight: 700;
      margin-top: 12px;
      display: block;
      font-size: 14px;
      color: #333;
    }
    input[type="text"], input[type="date"], input[type="password"], textarea {
      width: 100%;
      padding: 14px;
      margin-top: 4px;
      border: 2px solid #e0e7ff;
      border-radius: 12px;
      font-size: 15px;
      font-family: "Times New Roman", Times, serif;
      -webkit-appearance: none;
      transition: border-color 0.2s;
    }
    input[type="date"] {
      padding: 12px 14px;
    }
    input[type="text"]:focus, input[type="date"]:focus, textarea:focus {
      border-color: #2b5dab;
      outline: none;
    }
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    button {
      margin-top: 20px;
      padding: 16px 16px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    .btn-azul {
      background: #2b5dab;
      color: #fff;
    }
    .btn-verde {
      background: #2e7d32;
      color: #fff;
    }
    .btn-cinza {
      background: #6c757d;
      color: #fff;
    }
    .btn-outline {
      background: transparent;
      border: 2px solid #2b5dab;
      color: #2b5dab;
    }
    .botoes-duplo {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .botoes-duplo button {
      margin-top: 0;
      flex: 1;
    }
    
    /* Fases */
    .fase {
      display: none;
    }
    .fase.ativo {
      display: block;
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Parte 1 e 2 da Fase 1 */
    #parte1, #parte2 {
      transition: all 0.3s ease;
    }
    
    /* Fase 1 - Dados em duas colunas */
    .dados-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    
    .dados-coluna {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .dados-coluna label {
      margin-top: 0;
      font-size: 14px;
    }
    
    .dados-coluna input {
      padding: 14px;
      font-size: 15px;
    }
    
    /* Fase 2 - Explica√ß√£o */
    .explicacao-container {
      background: #f9fbfd;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #d0e3ff;
      margin: 20px 0;
    }
    
    .acao-destacada {
      background: linear-gradient(135deg, #1a4a8a, #2b5dab);
      color: white;
      font-size: 16px;
      font-weight: bold;
      padding: 18px 14px;
      margin: 15px 0;
      border-radius: 14px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(43, 93, 171, 0.3);
    }
    
    .acao-destacada::after {
      content: "‚Üí";
      font-size: 20px;
    }
    
    .instrucoes-chat {
      background: #e3f2fd;
      border-left: 4px solid #2b5dab;
      padding: 15px;
      border-radius: 0 12px 12px 0;
      margin: 15px 0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .botoes-quadro {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }
    
    .botoes-quadro button {
      margin: 0;
      padding: 16px 6px;
      font-size: 15px;
    }
    
    .btn-imagem {
      background: linear-gradient(135deg, #7b1fa2, #9c27b0);
      color: white;
    }
    
    .preview-imagem {
      max-width: 100%;
      max-height: 180px;
      display: block;
      margin: 15px auto;
      border-radius: 12px;
      border: 2px solid #ddd;
    }
    
    /* Fase 3 - PDF */
    .pagamento-section {
      background: #e6f0ff;
      border: 2px solid #a0c4ff;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .codigo-destaque {
      background: linear-gradient(135deg, #2b5dab, #1a4a8a);
      color: white;
      font-size: 32px;
      font-weight: bold;
      font-family: monospace;
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      letter-spacing: 4px;
      border: 2px solid #ffd700;
      text-align: center;
    }
    
    .plano-completo {
      margin: 20px 0;
      padding: 20px;
      border: 2px dashed #9fa8da;
      border-radius: 16px;
      background: #f5f9ff;
      position: relative;
      font-size: 13px;
      overflow: hidden;
    }
    
    .marca-dagua {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 10;
    }
    
    .marca-dagua span {
      font-size: 60px;
      font-weight: bold;
      color: rgba(220, 53, 69, 0.15);
      white-space: nowrap;
      transform: rotate(-30deg);
      text-transform: uppercase;
      border: 3px solid rgba(220, 53, 69, 0.2);
      padding: 20px 40px;
      border-radius: 20px;
    }
    
    /* Tabela com scroll - AJUSTADA PARA MARGEM DIREITA */
    .tabela-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 15px 0;
      position: relative;
      z-index: 5;
    }
    
    table {
      min-width: 1500px;
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: white;
      margin-left: auto;
      margin-right: 0;
    }
    
    th, td {
      border: 1px solid #000;
      padding: 6px 4px;
      vertical-align: top;
    }
    
    th {
      background: #e0e0e0;
      color: #000;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    td {
      color: #000;
    }
    
    /* TODAS as c√©lulas da tabela e objetivos s√£o edit√°veis */
    td[contenteditable="true"], p[contenteditable="true"] {
      background-color: #fff9e6;
      cursor: text;
      border-radius: 4px;
      padding: 4px 6px;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    td[contenteditable="true"]:focus, p[contenteditable="true"]:focus {
      outline: 2px solid #2b5dab;
      background-color: #fff3cd;
    }
    
    /* Garantir que elementos n√£o edit√°veis n√£o interfiram */
    td[contenteditable="true"] * {
      pointer-events: none;
    }
    
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      width: 0%;
      height: 30px;
      background: linear-gradient(90deg, #2b5dab, #4a7fd4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .rodape {
      text-align: center;
      font-style: italic;
      margin-top: 30px;
      color: #555;
      font-size: 13px;
    }
    
    #mensagemCodigo {
      font-size: 14px;
      word-break: break-word;
      margin: 10px 0;
      font-weight: bold;
    }

    /* Estilo para a explica√ß√£o dentro do plano (s√≥ aparece ao clicar) */
    .explicacao-plano {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #2b5dab;
      position: relative;
      z-index: 5;
      background: white;
    }
    
    .explicacao-plano h4 {
      color: #2b5dab;
      margin-bottom: 10px;
    }
    
    @media (max-width: 480px) {
      h1 { font-size: 20px; }
      .fase-numero { margin-right: 4px; }
      .dados-grid { grid-template-columns: 1fr; gap: 5px; }
      .botoes-quadro { grid-template-columns: 1fr; }
      .botoes-duplo { flex-direction: column; }
      .marca-dagua span { font-size: 40px; }
    }
  </style>
</head>
<body oncontextmenu="return false" oncopy="return false" oncut="return false" onpaste="return false" onkeydown="return disableKeys(event)">
  <div class="container">
    <!-- Indicador de fases -->
    <div class="fases-indicador">
      <div class="fase-item ativo" id="indicadorFase1">
        <span class="fase-numero">1</span> Dados
      </div>
      <div class="fase-item" id="indicadorFase2">
        <span class="fase-numero">2</span> Explica√ß√£o
      </div>
      <div class="fase-item" id="indicadorFase3">
        <span class="fase-numero">3</span> PDF
      </div>
    </div>

    <!-- FASE 1: DADOS (dividida em duas partes) -->
    <div id="fase1" class="fase ativo">
      <h1>Plano de Aula MZ</h1>
      <h3>Edmilson Nhanombe Nhanombe</h3>

      <!-- PARTE 1: Escola at√© Unidade Tem√°tica -->
      <div id="parte1">
        <div class="dados-grid">
          <div class="dados-coluna">
            <label>Escola:</label>
            <input type="text" id="escola" placeholder="Digite o nome da escola" maxlength="60" />
            
            <label>Data (opcional):</label>
            <input type="date" id="data" />
            
            <label>Professor:</label>
            <input type="text" id="professor" placeholder="Nome completo" maxlength="60" />
          </div>
          <div class="dados-coluna">
            <label>Disciplina:</label>
            <input type="text" id="disciplina" placeholder="Ex: Matem√°tica" maxlength="60" />
            
            <label>Classe:</label>
            <input type="text" id="classe" placeholder="Ex: 8" maxlength="2" />
            
            <label>Unidade Tem√°tica:</label>
            <input type="text" id="unidade" placeholder="Ex: Geometria" maxlength="80" />
          </div>
        </div>
        <button class="btn-azul" onclick="mostrarParte2()">PR√ìXIMO ‚Üí</button>
      </div>
      
      <!-- PARTE 2: Tema, Turma, Alunos, Per√≠odo, Li√ß√£o, Tipo de Aula -->
      <div id="parte2" style="display:none;">
        <div class="dados-grid">
          <div class="dados-coluna">
            <label>Tema da Aula:</label>
            <input type="text" id="tema" placeholder="Ex: Tri√¢ngulos" maxlength="120" />
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label>Turma:</label>
                <input type="text" id="turma" placeholder="Ex: A" maxlength="1" />
              </div>
              <div>
                <label>Alunos:</label>
                <input type="text" id="numAlunos" placeholder="Ex: 35" maxlength="4" />
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label>Per√≠odo:</label>
                <input type="text" id="periodo" placeholder="Ex: Manh√£" maxlength="30" />
              </div>
              <div>
                <label>Li√ß√£o n¬∫:</label>
                <input type="text" id="numLicao" placeholder="Ex: 12" maxlength="4" />
              </div>
            </div>
          </div>
          <div class="dados-coluna">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label>Tipo de Aula:</label>
                <input type="text" id="tipoAula" placeholder="Ex: Expositiva" maxlength="40" />
              </div>
              <div>
                <label>Dura√ß√£o:</label>
                <input type="text" id="duracao" value="45 minutos" readonly style="background:#f0f0f0;" />
              </div>
            </div>
          </div>
        </div>
        
        <div class="botoes-duplo">
          <button class="btn-outline" onclick="voltarParte1()">‚Üê VOLTAR</button>
          <button class="btn-azul" onclick="irParaFase2()">EXPLICA√á√ÉO DO TEMA ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- FASE 2: EXPLICA√á√ÉO (Quadro Mural) -->
    <div id="fase2" class="fase">
      <h1>Plano de Aula MZ</h1>
      <h3>Edmilson Nhanombe Nhanombe</h3>

      <div class="explicacao-container">
        <h2 style="text-align:center; color:#2b5dab; margin-bottom:20px;">QUADRO MURAL</h2>
        
        <button class="acao-destacada" onclick="buscarExplicacao()" id="botaoExplicacao">
          üîç BUSCAR EXPLICA√á√ÉO NO CHATGPT
        </button>
        
        <div class="instrucoes-chat">
          <strong>üìå Instru√ß√µes:</strong><br>
          1. Clique no bot√£o acima para abrir o ChatGPT<br>
          2. Copie a explica√ß√£o gerada (m√°ximo 1 p√°gina, inclua 3 exerc√≠cios com respostas)<br>
          3. Cole no campo abaixo e clique em SALVAR<br>
          4. Depois clique em "VISUALIZAR PLANO N√ÉO PAGO" para ver a explica√ß√£o por baixo da tabela
        </div>
        
        <textarea id="campoEdicaoQuadro" placeholder="Cole aqui a explica√ß√£o completa do ChatGPT (inclua 3 exerc√≠cios com respostas)"></textarea>
        
        <div class="botoes-quadro">
          <button class="btn-azul" onclick="salvarExplicacao()">üíæ SALVAR TEXTO</button>
          <button class="btn-imagem" onclick="document.getElementById('inputFotoLivro').click()">üì∑ CARREGAR FOTO</button>
          <input type="file" id="inputFotoLivro" accept="image/*" style="display:none;" onchange="exibirFotoLivro(event)">
          <button class="btn-cinza" onclick="apagarExplicacao()">üóëÔ∏è LIMPAR</button>
        </div>
        
        <div id="previewFotoLivro" style="text-align:center;"></div>
      </div>

      <!-- Bot√£o visualizar plano n√£o pago - A explica√ß√£o aparece aqui por baixo da tabela -->
      <button class="btn-outline" onclick="togglePlanoNaoPago()">üëÅÔ∏è VISUALIZAR PLANO N√ÉO PAGO</button>
      
      <div id="planoNaoPagoSection" style="display:none;" class="plano-completo">
        <div class="marca-dagua"><span>N√ÉO PAGO</span></div>
        <div id="planoPDF"></div>
        <!-- A explica√ß√£o aparece aqui por baixo da tabela -->
        <div id="explicacaoNoPlano" class="explicacao-plano" style="display:none;"></div>
        <div id="imagemNoPlano" class="explicacao-plano" style="display:none;"></div>
      </div>

      <div class="botoes-duplo" style="margin-top:20px;">
        <button class="btn-outline" onclick="voltarParaFase1()">‚Üê VOLTAR</button>
        <button class="btn-verde" onclick="irParaFase3()">üì• GERAR PDF</button>
      </div>
    </div>

    <!-- FASE 3: PDF (com c√≥digo) -->
    <div id="fase3" class="fase">
      <h1>Plano de Aula MZ</h1>
      <h3>Edmilson Nhanombe Nhanombe</h3>

      <!-- √Årea de c√≥digo (sem rascunho) -->
      <div class="pagamento-section" id="codigoSection">
        <p style="font-weight:bold; text-align:center; margin-bottom:15px;">üîê INSIRA O C√ìDIGO DE ACESSO</p>
        
        <!-- C√≥digo gerado aleatoriamente -->
        <div class="codigo-destaque" id="codigoAtual">---</div>
        
        <p style="text-align:center; margin:10px 0;">Digite o c√≥digo acima para gerar o PDF</p>
        
        <input type="text" id="codigoAcesso" class="input-codigo" placeholder="Digite o c√≥digo" maxlength="8" style="text-align:center; font-size:22px; letter-spacing:3px; font-weight:bold; text-transform:uppercase;" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
        
        <div id="mensagemCodigo" style="color:#b00; text-align:center;"></div>
        <div class="loading" id="loading" style="display:none; text-align:center;">‚è≥ Validando...</div>
        
        <button class="btn-verde" onclick="validarCodigo()" style="margin-top:15px;">‚úÖ CONFIRMAR C√ìDIGO</button>
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar">
          <span class="progress-text" id="progressText">0%</span>
        </div>
      </div>

      <div class="botoes-duplo">
        <button class="btn-outline" onclick="voltarParaFase2()">‚Üê VOLTAR</button>
      </div>
    </div>
  </div>

  <script>
    // Bloqueio total de teclas de atalho e c√≥pia - MAS PERMITE EDI√á√ÉO
    function disableKeys(e) {
      // Permitir teclas normais de edi√ß√£o (letras, n√∫meros, backspace, delete, setas, etc)
      const key = e.key || e.keyCode;
      
      // Lista de teclas que devem ser permitidas para edi√ß√£o
      const allowedKeys = [
        'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
        'Home', 'End', 'Tab', 'Enter', 'Shift'
      ];
      
      // Permitir teclas de edi√ß√£o normais
      if (allowedKeys.includes(e.key)) {
        return true;
      }
      
      // Permitir letras, n√∫meros e caracteres comuns (para digita√ß√£o)
      if (e.key.length === 1) {
        return true;
      }
      
      // Bloquear apenas teclas de fun√ß√£o e combina√ß√µes perigosas
      
      // F2 (113)
      if (key === 113 || key === 'F2') {
        e.preventDefault();
        return false;
      }
      
      // F5 (116)
      if (key === 116 || key === 'F5') {
        e.preventDefault();
        return false;
      }
      
      // F11 (122)
      if (key === 122 || key === 'F11') {
        e.preventDefault();
        return false;
      }
      
      // F12 (123)
      if (key === 123 || key === 'F12') {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+Shift+I (Desenvolvedor)
      if (e.ctrlKey && e.shiftKey && (key === 73 || key === 'I')) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+Shift+J (Console)
      if (e.ctrlKey && e.shiftKey && (key === 74 || key === 'J')) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+U (Ver c√≥digo fonte)
      if (e.ctrlKey && (key === 85 || key === 'U')) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+S (Salvar)
      if (e.ctrlKey && (key === 83 || key === 'S')) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+P (Imprimir)
      if (e.ctrlKey && (key === 80 || key === 'P')) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+C (Copiar) - BLOQUEAR
      if (e.ctrlKey && (key === 67 || key === 'C')) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+X (Cortar) - BLOQUEAR
      if (e.ctrlKey && (key === 88 || key === 'X')) {
        e.preventDefault();
        return false;
      }
      
      // Ctrl+V (Colar) - BLOQUEAR
      if (e.ctrlKey && (key === 86 || key === 'V')) {
        e.preventDefault();
        return false;
      }
      
      return true;
    }

    // Bloqueio adicional de eventos - MAS PERMITE EDI√á√ÉO
    document.addEventListener('keydown', disableKeys);
    
    // Bloquear menu de contexto (clique direito)
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      return false;
    });
    
    // Bloquear arrastar
    document.addEventListener('dragstart', function(e) {
      e.preventDefault();
      return false;
    });
    
    // Bloquear PrintScreen
    document.addEventListener('keyup', function(e) {
      if (e.key === 'PrintScreen') {
        navigator.clipboard.writeText('').catch(() => {});
        alert('‚ùå Captura de ecr√£ bloqueada!');
        e.preventDefault();
        return false;
      }
    });
    
    // Bloquear combina√ß√µes de teclas com Alt (mas permitir AltGr para caracteres especiais)
    document.addEventListener('keydown', function(e) {
      if (e.altKey && !e.ctrlKey && e.key !== 'Alt' && e.key !== 'Control') {
        // Permitir AltGr (que √© Ctrl+Alt em algumas configura√ß√µes)
        if (e.ctrlKey && e.altKey) {
          return true;
        }
        e.preventDefault();
        return false;
      }
    });

    const { jsPDF } = window.jspdf;
    let tipoPagamentoSelecionado = null;
    let imagemQuadroMural = null;
    let explicacaoTexto = "";
    let codigoAtual = "";

    // Valida√ß√µes de input
    function apenasDigitosMax(el, maxLen) {
      el.value = el.value.replace(/\D/g, '').slice(0, maxLen || el.maxLength || 9999);
    }
    function apenasLetraUnica(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/g, '').slice(0, 1);
    }
    function apenasLetras(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]/g, '');
    }
    function letrasENumeros(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø0-9\s]/g, '');
    }
    function temaPermitido(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø0-9\s+\-\*\=\/\^_\(\)\{\}\[\]√ó√∑¬±‚àö%.,:;'"<>]/g, '');
    }
    function sanitizarQuadroInputRaw(str) {
      if (!str) return '';
      str = str.replace(/[\u{1F600}-\u{1F64F}]/gu, '')
               .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')
               .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
               .replace(/[\u{2600}-\u{26FF}]/gu, '')
               .replace(/[\u{2700}-\u{27BF}]/gu, '');
      return str.replace(/[^\w√Ä-√ñ√ò-√∂√∏-√ø\s0-9\.\,\;\:\?\!\-\‚Äì\‚Äî\(\)\'\"%\/\n\r]/g, '');
    }

    // Fun√ß√£o para formatar data do formato ISO para dd/mm/aaaa
    function formatarData(dataISO) {
      if (!dataISO) return '';
      const partes = dataISO.split('-');
      if (partes.length === 3) {
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
      }
      return dataISO;
    }

    // Fun√ß√£o para gerar c√≥digo aleat√≥rio
    function gerarCodigoAleatorio() {
      const prefixos = ['MZ', 'PL', 'AU', 'AL', 'UN', 'ZA', 'ES', 'PR', 'MO', 'CM'];
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      const prefixo = prefixos[Math.floor(Math.random() * prefixos.length)];
      let codigo = prefixo;
      for (let i = 0; i < 4; i++) {
        codigo += chars[Math.floor(Math.random() * chars.length)];
      }
      return codigo;
    }

    // Navega√ß√£o entre fases
    function mostrarParte2() {
      const escola = document.getElementById('escola').value.trim();
      const professor = document.getElementById('professor').value.trim();
      const disciplina = document.getElementById('disciplina').value.trim();
      const classe = document.getElementById('classe').value.trim();
      const unidade = document.getElementById('unidade').value.trim();
      
      if (!escola || !professor || !disciplina || !classe || !unidade) {
        alert('Preencha todos os campos obrigat√≥rios (data √© opcional)');
        return;
      }
      
      document.getElementById('parte1').style.display = 'none';
      document.getElementById('parte2').style.display = 'block';
    }

    function voltarParte1() {
      document.getElementById('parte1').style.display = 'block';
      document.getElementById('parte2').style.display = 'none';
    }

    function irParaFase2() {
      const tema = document.getElementById('tema').value.trim();
      const turma = document.getElementById('turma').value.trim();
      const numAlunos = document.getElementById('numAlunos').value.trim();
      const periodo = document.getElementById('periodo').value.trim();
      const numLicao = document.getElementById('numLicao').value.trim();
      const tipoAula = document.getElementById('tipoAula').value.trim();
      
      if (!tema || !turma || !numAlunos || !periodo || !numLicao || !tipoAula) {
        alert('Preencha todos os campos');
        return;
      }
      
      // Formatar data se existir
      const dataRaw = document.getElementById('data').value;
      const dataFormatada = formatarData(dataRaw);
      
      const planoData = {
        escola: document.getElementById('escola').value,
        data: dataFormatada,
        professor: document.getElementById('professor').value,
        disciplina: document.getElementById('disciplina').value,
        classe: document.getElementById('classe').value,
        tema: tema,
        unidade: document.getElementById('unidade').value,
        turma: turma,
        numAlunos: numAlunos,
        periodo: periodo,
        numLicao: numLicao,
        tipoAula: tipoAula
      };
      sessionStorage.setItem("planoData", JSON.stringify(planoData));
      
      gerarPlanoHTML(planoData);
      
      document.getElementById("fase1").classList.remove("ativo");
      document.getElementById("fase2").classList.add("ativo");
      document.getElementById("indicadorFase1").classList.remove("ativo");
      document.getElementById("indicadorFase2").classList.add("ativo");
    }

    function voltarParaFase1() {
      document.getElementById("fase2").classList.remove("ativo");
      document.getElementById("fase1").classList.add("ativo");
      document.getElementById("indicadorFase2").classList.remove("ativo");
      document.getElementById("indicadorFase1").classList.add("ativo");
      document.getElementById('parte1').style.display = 'block';
      document.getElementById('parte2').style.display = 'none';
    }

    function irParaFase3() {
      const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
      
      document.getElementById("fase2").classList.remove("ativo");
      document.getElementById("fase3").classList.add("ativo");
      document.getElementById("indicadorFase2").classList.remove("ativo");
      document.getElementById("indicadorFase3").classList.add("ativo");
      
      codigoAtual = gerarCodigoAleatorio();
      document.getElementById('codigoAtual').textContent = codigoAtual;
      document.getElementById('codigoAcesso').value = '';
      document.getElementById('mensagemCodigo').innerHTML = '';
    }

    function voltarParaFase2() {
      document.getElementById("fase3").classList.remove("ativo");
      document.getElementById("fase2").classList.add("ativo");
      document.getElementById("indicadorFase3").classList.remove("ativo");
      document.getElementById("indicadorFase2").classList.add("ativo");
    }

    function togglePlanoNaoPago() {
      const el = document.getElementById("planoNaoPagoSection");
      if (el.style.display === "none") {
        // Atualizar a explica√ß√£o antes de mostrar
        if (explicacaoTexto) {
          document.getElementById("explicacaoNoPlano").style.display = "block";
          document.getElementById("imagemNoPlano").style.display = "none";
        } else if (imagemQuadroMural) {
          document.getElementById("imagemNoPlano").style.display = "block";
          document.getElementById("explicacaoNoPlano").style.display = "none";
        }
      }
      el.style.display = el.style.display === "none" ? "block" : "none";
    }

    // Gerar HTML do plano - TODOS os objetivos e TODAS as c√©lulas da tabela s√£o edit√°veis
    function gerarPlanoHTML(planoData) {
      const { escola, data, professor, disciplina, classe, tema, unidade, turma, numAlunos, periodo, numLicao, tipoAula } = planoData;

      const objGeral = `Desenvolver compet√™ncias relacionadas com o tema "${tema}".`;
      const objCog = `Compreender e explicar o conte√∫do sobre "${tema}".`;
      const objPsi = `Aplicar os conhecimentos sobre "${tema}".`;
      const objAfet = `Valorizar a import√¢ncia de "${tema}" no dia a dia.`;

      // TABELA COM FORMATO CORRETO - TODAS AS C√âLULAS EDIT√ÅVEIS
      const conteudoPadraoTabela = [
        ["00‚Äì05 min", "Introdu√ß√£o e motiva√ß√£o", "Sauda√ß√£o e organiza√ß√£o", 
         "- Sa√∫da os alunos;\n- Verifica ambiente;\n- Marca presen√ßa;\n- Orientar breve recapitula√ß√£o da aula anterior;\n- Apresenta o tema: " + tema, 
         "- Responde √† sauda√ß√£o;\n- Responde √† presen√ßa;\n- Indicado ou volunt√°rio faz recapitula√ß√£o;\n- Anota o tema", 
         "Expositivo", "Quadro e giz"],
        ["05‚Äì20 min", "Media√ß√£o e assimila√ß√£o", "Explora√ß√£o do tema: " + tema, 
         "- Faz perguntas em prol do tema;\n- Explica o tema;\n- Usa exemplos do quotidiano;\n- Relaciona com o dia a dia", 
         "- Participa;\n- Relaciona o tema;\n- Regista exemplos", "Elabora√ß√£o conjunta", "Quadro e livro"],
        ["20‚Äì35 min", "Dom√≠nio e consolida√ß√£o", "Exerc√≠cios pr√°ticos", 
         "- Prop√µe exerc√≠cios;\n- Circula pela sala;\n- Esclarece d√∫vidas", 
         "- Resolve os exerc√≠cios;\n- Solicita ajuda", "Trabalho independente", "Caderno"],
        ["35‚Äì45 min", "Controlo e avalia√ß√£o", "Avalia√ß√£o e TPC", 
         "- Recolhe respostas;\n- Marca o TPC;\n- Faz resumo do tema e despede-se", 
         "- Apresenta respostas;\n- Copia o TPC;\n- Despede-se", "Trabalho independente", "Folha/caderno"]
      ];

      let tabelaHTML = '';
      conteudoPadraoTabela.forEach(linha => {
        tabelaHTML += `
          <tr>
            <td contenteditable="true">${linha[0]}</td>
            <td contenteditable="true">${linha[1]}</td>
            <td contenteditable="true">${linha[2]}</td>
            <td contenteditable="true">${linha[3].replace(/\n/g, '<br>')}</td>
            <td contenteditable="true">${linha[4].replace(/\n/g, '<br>')}</td>
            <td contenteditable="true">${linha[5]}</td>
            <td contenteditable="true">${linha[6]}</td>
          </tr>`;
      });

      const planoHTML = `
        <h2 style="text-align:center; margin:0 0 10px;">PLANO DE AULA</h2>
        <div style="display: flex; justify-content: space-between; font-size:12px; margin-bottom:5px;">
          <div>
            <p><strong>Escola:</strong> <span>${escola}</span></p>
            <p><strong>Data:</strong> <span>${data || ''}</span></p>
            <p><strong>Professor:</strong> <span>${professor}</span></p>
            <p><strong>Disciplina:</strong> <span>${disciplina}</span></p>
            <p><strong>Unidade Tem√°tica:</strong> <span>${unidade}</span></p>
          </div>
          <div style="text-align: right;">
            <p><strong>Classe:</strong> <span>${classe}</span></p>
            <p><strong>Turma:</strong> <span>${turma}</span></p>
            <p><strong>N¬∫ de Alunos:</strong> <span>${numAlunos}</span></p>
            <p><strong>Li√ß√£o n¬∫:</strong> <span>${numLicao}</span></p>
            <p><strong>Dura√ß√£o:</strong> 45 minutos</p>
            <p><strong>Per√≠odo:</strong> <span>${periodo}</span></p>
            <p><strong>Tipo de Aula:</strong> <span>${tipoAula}</span></p>
          </div>
        </div>
        <p style="margin:5px 0;"><strong>Tema:</strong> <span>${tema}</span></p>

        <p contenteditable="true" style="margin:5px 0;"><strong>Objetivo Geral:</strong> ${objGeral}</p>
        <p><strong>Objetivos Espec√≠ficos:</strong></p>
        <p contenteditable="true" style="margin:2px 0;"><strong>Cognitivo:</strong> ${objCog}</p>
        <p contenteditable="true" style="margin:2px 0;"><strong>Psicomotor:</strong> ${objPsi}</p>
        <p contenteditable="true" style="margin:2px 0;"><strong>Afetivo:</strong> ${objAfet}</p>

        <div class="tabela-wrapper">
          <table id="tabelaPlano" border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse; margin-top:5px;">
            <thead>
              <tr>
                <th>TEMPO</th>
                <th>FUN√á√ÉO DID√ÅCTICA</th>
                <th>CONTE√öDOS</th>
                <th>ACTIVIDADES DO PROFESSOR</th>
                <th>ACTIVIDADES DOS ALUNOS</th>
                <th>M√âTODOS</th>
                <th>MEIOS</th>
              </tr>
            </thead>
            <tbody>
              ${tabelaHTML}
            </tbody>
          </table>
        </div>
      `;
      
      document.getElementById("planoPDF").innerHTML = planoHTML;
      
      // Preparar explica√ß√£o no plano n√£o pago
      if (explicacaoTexto) {
        document.getElementById("explicacaoNoPlano").innerHTML = `
          <h4 style="color:#2b5dab;">EXPLICA√á√ÉO DO TEMA</h4>
          <div style="white-space:pre-wrap;">${explicacaoTexto.replace(/\n/g, '<br>')}</div>
        `;
      } else if (imagemQuadroMural) {
        document.getElementById("imagemNoPlano").innerHTML = `
          <h4 style="color:#2b5dab;">IMAGEM DO LIVRO</h4>
          <img src="${imagemQuadroMural}" style="max-width:100%; max-height:300px;">
        `;
      }
    }

    // Fun√ß√µes da Fase 2
    function buscarExplicacao() {
      const botao = document.getElementById("botaoExplicacao");
      const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
      const tema = planoData.tema || "";
      
      if (!tema) { alert("‚ö†Ô∏è Tema n√£o encontrado."); return; }

      botao.innerHTML = "‚è≥ ABRINDO CHATGPT...";
      botao.disabled = true;

      const query = `Explique o tema "${tema}" para alunos mo√ßambicanos. M√°x 1 p√°gina. Inclua 3 exerc√≠cios com respostas.`;
      const url = `https://chat.openai.com/?q=${encodeURIComponent(query)}`;
      
      setTimeout(() => {
        const janelaChat = window.open(url, "_blank");
        if (janelaChat) {
          janelaChat.focus();
          botao.innerHTML = "‚úÖ ABERTO! COLE O RESULTADO";
          setTimeout(() => {
            botao.innerHTML = "üîç BUSCAR NOVAMENTE";
            botao.disabled = false;
          }, 4000);
        } else {
          botao.innerHTML = "‚ùå ERRO (pop-up bloqueado)";
          setTimeout(() => { botao.innerHTML = "üîÅ TENTAR NOVAMENTE"; botao.disabled = false; }, 2000);
        }
      }, 500);
    }

    function salvarExplicacao() {
      const texto = document.getElementById("campoEdicaoQuadro").value.trim();
      if (!texto) { alert("‚ö†Ô∏è Cole a explica√ß√£o primeiro."); return; }

      let textoSanitizado = sanitizarQuadroInputRaw(texto);
      const palavras = textoSanitizado.split(/\s+/);
      if (palavras.length > 450) {
        textoSanitizado = palavras.slice(0, 450).join(' ') + '...';
      }
      
      explicacaoTexto = textoSanitizado;
      imagemQuadroMural = null;
      
      const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
      gerarPlanoHTML(planoData);
      
      const botao = event.target;
      botao.innerHTML = "‚úÖ SALVO!";
      setTimeout(() => { botao.innerHTML = "üíæ SALVAR TEXTO"; }, 1500);
      document.getElementById("campoEdicaoQuadro").value = "";
      document.getElementById("previewFotoLivro").innerHTML = "";
      
      alert("Explica√ß√£o salva! Clique em 'VISUALIZAR PLANO N√ÉO PAGO' para ver o resultado.");
    }

    function exibirFotoLivro(event) {
      const file = event.target.files[0];
      if (!file || !file.type.match('image.*') || file.size > 5242880) {
        alert("Imagem inv√°lida ou muito grande (m√°x 5MB)");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const imgData = e.target.result;
        imagemQuadroMural = imgData;
        explicacaoTexto = "";
        
        document.getElementById("previewFotoLivro").innerHTML = `
          <img src="${imgData}" class="preview-imagem" alt="Foto">
          <button class="btn-cinza" onclick="removerFoto()" style="padding:10px; width:auto;">üóëÔ∏è Remover</button>`;
        
        const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
        gerarPlanoHTML(planoData);
        document.getElementById("campoEdicaoQuadro").value = "";
        
        alert("Imagem carregada! Clique em 'VISUALIZAR PLANO N√ÉO PAGO' para ver.");
      };
      reader.readAsDataURL(file);
    }

    function removerFoto() {
      imagemQuadroMural = null;
      document.getElementById("previewFotoLivro").innerHTML = "";
      const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
      gerarPlanoHTML(planoData);
    }

    function apagarExplicacao() {
      document.getElementById("campoEdicaoQuadro").value = "";
      imagemQuadroMural = null;
      explicacaoTexto = "";
      document.getElementById("previewFotoLivro").innerHTML = "";
      const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
      gerarPlanoHTML(planoData);
    }

    // Fun√ß√µes da Fase 3
    function simularProgresso() {
      const pc = document.getElementById("progressContainer");
      const pb = document.getElementById("progressBar");
      const pt = document.getElementById("progressText");
      pc.style.display = "block";
      let p = 0;
      const i = setInterval(() => {
        p += 2;
        pb.style.width = p + "%";
        pt.textContent = p + "%";
        if (p >= 100) clearInterval(i);
      }, 30);
    }

    function validarCodigo() {
      const codigo = document.getElementById("codigoAcesso").value.trim().toUpperCase();
      const msg = document.getElementById("mensagemCodigo");
      const loading = document.getElementById("loading");
      
      if (!codigo) { msg.innerHTML = "‚ö†Ô∏è Digite o c√≥digo"; return; }
      
      loading.style.display = "block";
      msg.innerHTML = "Validando...";
      simularProgresso();

      setTimeout(() => {
        if (codigo === codigoAtual) {
          msg.style.color = "green";
          msg.innerHTML = "‚úÖ C√≥digo v√°lido! Gerando PDF...";
          
          setTimeout(() => {
            document.getElementById("progressContainer").style.display = "none";
            baixarPDF();
            msg.innerHTML = "‚úÖ PDF gerado!";
            loading.style.display = "none";
            
            codigoAtual = gerarCodigoAleatorio();
            document.getElementById('codigoAtual').textContent = codigoAtual;
            document.getElementById('codigoAcesso').value = '';
            
            setTimeout(() => {
              document.getElementById("fase3").classList.remove("ativo");
              document.getElementById("fase1").classList.add("ativo");
              document.getElementById("indicadorFase3").classList.remove("ativo");
              document.getElementById("indicadorFase1").classList.add("ativo");
              document.getElementById('parte1').style.display = 'block';
              document.getElementById('parte2').style.display = 'none';
            }, 1500);
          }, 1000);
        } else {
          msg.innerHTML = "‚ùå C√≥digo inv√°lido!";
          loading.style.display = "none";
          document.getElementById("progressContainer").style.display = "none";
        }
      }, 2000);
    }

    // FUN√á√ÉO PDF - CAPTURA DADOS EDITADOS E TABELA AJUSTADA COM MARGENS CORRIGIDAS
    function baixarPDF() {
      const planoDataJSON = sessionStorage.getItem("planoData");
      if (!planoDataJSON) { alert("‚ùå Nenhum plano encontrado."); return; }
      
      const planoData = JSON.parse(planoDataJSON);
      
      // CAPTURAR DADOS EDITADOS DIRETAMENTE DO HTML
      const planoPDFElement = document.getElementById("planoPDF");
      
      // Extrair valor da escola do HTML (n√£o duplicar)
      const escolaElement = planoPDFElement.querySelector('div p span');
      const escolaTexto = escolaElement ? escolaElement.innerText.trim() : planoData.escola;
      
      // Fun√ß√£o para extrair texto de elementos contenteditable
      function extrairTextoContentEditable(label) {
        const elementos = planoPDFElement.querySelectorAll('[contenteditable="true"]');
        for (let el of elementos) {
          const parentText = el.parentElement ? el.parentElement.innerText : '';
          if (parentText.includes(label) || (el.previousSibling && el.previousSibling.textContent && el.previousSibling.textContent.includes(label))) {
            return el.innerText.trim();
          }
        }
        return '';
      }
      
      // Capturar objetivos editados
      const objetivos = planoPDFElement.querySelectorAll('p[contenteditable="true"]');
      const objGeralTexto = objetivos[0] ? objetivos[0].innerText.replace("Objetivo Geral:", "").trim() : `Desenvolver compet√™ncias sobre "${planoData.tema}".`;
      const objCogTexto = objetivos[1] ? objetivos[1].innerText.replace("Cognitivo:", "").trim() : `Compreender e explicar "${planoData.tema}".`;
      const objPsiTexto = objetivos[2] ? objetivos[2].innerText.replace("Psicomotor:", "").trim() : `Aplicar conhecimentos sobre "${planoData.tema}".`;
      const objAfetTexto = objetivos[3] ? objetivos[3].innerText.replace("Afetivo:", "").trim() : `Valorizar a import√¢ncia de "${planoData.tema}".`;

      const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
      
      // Configurar fonte padr√£o para Times New Roman
      doc.setFont("times", "normal");
      
      // T√çTULO - 12pt
      doc.setFont("times", "bold");
      doc.setFontSize(12);
      doc.text("PLANO DE AULA", 148, 10, { align: "center" });

      // DADOS B√ÅSICOS - todos 12pt com espa√ßo ap√≥s : e coluna direita a 250mm
      let y = 16;
      doc.setFont("times", "normal");
      doc.setFontSize(12);
      
      // Fun√ß√£o para adicionar linha com espa√ßamento ap√≥s :
      const addLinha = (label, valor, x, y, isBold = true) => {
        if (isBold) {
          doc.setFont("times", "bold");
          doc.text(label + ":", x, y);
          doc.setFont("times", "normal");
        } else {
          doc.text(label + ":", x, y);
        }
        // Adicionar dois espa√ßos ap√≥s os dois pontos
        doc.text("  " + (valor || ""), x + doc.getTextWidth(label + ":") + 2, y);
      };

      // Linha 1: Escola (esquerda) e Classe (direita a 250mm)
      addLinha("Escola", escolaTexto, 10, y);
      doc.setFont("times", "bold");
      doc.text("Classe:", 250, y);
      doc.setFont("times", "normal");
      doc.text("  " + (planoData.classe || ""), 250 + doc.getTextWidth("Classe:") + 2, y);
      y += 5;
      
      // Linha 2: Data e Turma
      addLinha("Data", planoData.data, 10, y);
      doc.setFont("times", "bold");
      doc.text("Turma:", 250, y);
      doc.setFont("times", "normal");
      doc.text("  " + (planoData.turma || ""), 250 + doc.getTextWidth("Turma:") + 2, y);
      y += 5;
      
      // Linha 3: Professor e Alunos
      addLinha("Professor", planoData.professor, 10, y);
      doc.setFont("times", "bold");
      doc.text("Alunos:", 250, y);
      doc.setFont("times", "normal");
      doc.text("  " + (planoData.numAlunos || ""), 250 + doc.getTextWidth("Alunos:") + 2, y);
      y += 5;
      
      // Linha 4: Disciplina e Li√ß√£o n¬∫
      addLinha("Disciplina", planoData.disciplina, 10, y);
      doc.setFont("times", "bold");
      doc.text("Li√ß√£o n¬∫:", 250, y);
      doc.setFont("times", "normal");
      doc.text("  " + (planoData.numLicao || ""), 250 + doc.getTextWidth("Li√ß√£o n¬∫:") + 2, y);
      y += 5;
      
      // Linha 5: Unidade Tem√°tica e Per√≠odo
      addLinha("Unidade Tem√°tica", planoData.unidade, 10, y);
      doc.setFont("times", "bold");
      doc.text("Per√≠odo:", 250, y);
      doc.setFont("times", "normal");
      doc.text("  " + (planoData.periodo || ""), 250 + doc.getTextWidth("Per√≠odo:") + 2, y);
      y += 5;
      
      // Linha 6: Tema e Dura√ß√£o
      doc.setFont("times", "bold");
      doc.text("Tema:", 10, y);
      doc.setFont("times", "normal");
      doc.text("  " + (planoData.tema || ""), 10 + doc.getTextWidth("Tema:") + 2, y);
      
      doc.setFont("times", "bold");
      doc.text("Dura√ß√£o:", 250, y);
      doc.setFont("times", "normal");
      doc.text("  45 min", 250 + doc.getTextWidth("Dura√ß√£o:") + 2, y);
      y += 5;
      
      // Linha 7: Tipo de Aula
      doc.setFont("times", "bold");
      doc.text("Tipo de Aula:", 10, y);
      doc.setFont("times", "normal");
      doc.text("  " + (planoData.tipoAula || ""), 10 + doc.getTextWidth("Tipo de Aula:") + 2, y);
      y += 7;

      // OBJETIVOS - todos 12pt com dados editados e espa√ßo ap√≥s :
      doc.setFont("times", "bold");
      doc.setFontSize(12);
      doc.text("Objetivos:", 10, y);
      y += 5;
      
      doc.setFont("times", "bold");
      doc.text("GERAL:", 15, y);
      doc.setFont("times", "normal");
      doc.text("  " + objGeralTexto, 15 + doc.getTextWidth("GERAL:") + 2, y);
      y += 5;
      
      doc.setFont("times", "bold");
      doc.text("COGNITIVO:", 15, y);
      doc.setFont("times", "normal");
      doc.text("  " + objCogTexto, 15 + doc.getTextWidth("COGNITIVO:") + 2, y);
      y += 5;
      
      doc.setFont("times", "bold");
      doc.text("PSICOMOTOR:", 15, y);
      doc.setFont("times", "normal");
      doc.text("  " + objPsiTexto, 15 + doc.getTextWidth("PSICOMOTOR:") + 2, y);
      y += 5;
      
      doc.setFont("times", "bold");
      doc.text("AFECTIVO:", 15, y);
      doc.setFont("times", "normal");
      doc.text("  " + objAfetTexto, 15 + doc.getTextWidth("AFECTIVO:") + 2, y);
      y += 7;

      // TABELA - capturar dados editados da tabela com larguras ajustadas
      const tabela = document.querySelector('#tabelaPlano');
      let tableData = [];
      
      if (tabela) {
        const rows = tabela.querySelectorAll("tbody tr");
        tableData = Array.from(rows).map(row => {
          const cells = row.querySelectorAll("td");
          return [
            cells[0]?.innerText.trim() || "",
            cells[1]?.innerText.trim() || "",
            cells[2]?.innerText.trim() || "",
            cells[3]?.innerText.trim() || "",
            cells[4]?.innerText.trim() || "",
            cells[5]?.innerText.trim() || "",
            cells[6]?.innerText.trim() || ""
          ];
        });
      }
      
      // Fallback se n√£o conseguir extrair
      if (tableData.length === 0) {
        tableData = [
          ["00-05 min", "Introdu√ß√£o e motiva√ß√£o", "Sauda√ß√£o e organiza√ß√£o", 
           "- Sa√∫da os alunos; - Verifica ambiente; - Marca presen√ßa; - Orientar recapitula√ß√£o; - Apresenta o tema: " + planoData.tema,
           "- Responde; - Recapitula; - Anota tema", "Expositivo", "Quadro e giz"],
          ["05-20 min", "Media√ß√£o", "Explora√ß√£o: " + planoData.tema, 
           "- Faz perguntas; - Explica; - Usa exemplos; - Relaciona", "- Participa; - Regista", "Elabora√ß√£o conjunta", "Quadro/livro"],
          ["20-35 min", "Consolida√ß√£o", "Exerc√≠cios", "- Prop√µe; - Circula; - Esclarece", "- Resolve; - Pede ajuda", "Independente", "Caderno"],
          ["35-45 min", "Avalia√ß√£o", "TPC", "- Recolhe; - Marca TPC; - Resume", "- Apresenta; - Copia; - Despede", "Independente", "Folha"]
        ];
      }

      doc.autoTable({
        startY: y,
        head: [['TEMPO','FUN√á√ÉO DID√ÅCTICA','CONTE√öDOS','ACTIVIDADES DO PROFESSOR','ACTIVIDADES DOS ALUNOS','M√âTODOS','MEIOS']],
        body: tableData,
        theme: 'grid',
        styles: { 
          font: 'times', 
          fontSize: 12,
          textColor: '#000000',
          lineColor: '#000000',
          lineWidth: 0.1,
          halign: 'left',
          cellPadding: 2,
          overflow: 'linebreak'
        },
        headStyles: { 
          fillColor: [224, 224, 224], 
          textColor: [0, 0, 0], 
          fontStyle: 'bold',
          halign: 'center',
          fontSize: 12,
          lineColor: '#000000'
        },
        columnStyles: {
          0: { cellWidth: 23 },
          1: { cellWidth: 35 },
          2: { cellWidth: 35 },
          3: { cellWidth: 65, halign: 'left' },
          4: { cellWidth: 65, halign: 'left' },
          5: { cellWidth: 28 },
          6: { cellWidth: 30 }
        },
        // N√ÉO repete cabe√ßalho em p√°ginas seguintes
        showHead: 'firstPage',
        margin: { left: 6, right: 3 },
        didDrawPage: function(data) {
          data.settings.margin.right = 3;
        }
      });

      // QUADRO MURAL - tudo 12pt Times New Roman
      doc.addPage();
      doc.setFont("times", "bold");
      doc.setFontSize(12);
      doc.text("QUADRO MURAL", 148, 10, { align: 'center' });
      
      // Adicionar explica√ß√£o do tema
      if (imagemQuadroMural) {
        doc.setFont("times", "normal");
        doc.setFontSize(12);
        doc.text("ILUSTRA√á√ÉO:", 10, 20);
        doc.addImage(imagemQuadroMural, 'JPEG', 15, 25, 267, 160, undefined, 'FAST');
      } else if (explicacaoTexto) {
        doc.setFont("times", "bold");
        doc.setFontSize(12);
        doc.text("EXPLICA√á√ÉO DO TEMA:", 10, 20);
        doc.setFont("times", "normal");
        doc.setFontSize(12);
        
        const margin = 15;
        const pageWidth = doc.internal.pageSize.getWidth();
        const textWidth = pageWidth - 2 * margin;
        let currentY = 28;
        const lineHeight = 6;
        
        // Processar o texto preservando quebras de linha
        const linhas = doc.splitTextToSize(explicacaoTexto, textWidth);
        
        linhas.forEach(linha => {
          if (currentY > 190) {
            doc.addPage();
            doc.setFont("times", "bold");
            doc.setFontSize(12);
            doc.text("QUADRO MURAL (continua√ß√£o)", 148, 10, { align: 'center' });
            currentY = 20;
          }
          doc.text(linha, margin, currentY);
          currentY += lineHeight;
        });
      } else {
        doc.setFont("times", "italic");
        doc.setFontSize(12);
        doc.text("Nenhuma explica√ß√£o foi adicionada.", 148, 50, { align: 'center' });
      }

      const dataFileName = planoData.data?.replace(/[\/]/g, "-") || 'plano';
      doc.save(`Plano_de_Aula_MZ_${dataFileName}.pdf`);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const validations = [
        { id: 'classe', fn: (e) => apenasDigitosMax(e.target, 2) },
        { id: 'turma', fn: (e) => apenasLetraUnica(e.target) },
        { id: 'numAlunos', fn: (e) => apenasDigitosMax(e.target) },
        { id: 'numLicao', fn: (e) => apenasDigitosMax(e.target) },
        { id: 'periodo', fn: (e) => apenasLetras(e.target) },
        { id: 'escola', fn: (e) => apenasLetras(e.target) },
        { id: 'professor', fn: (e) => apenasLetras(e.target) },
        { id: 'disciplina', fn: (e) => apenasLetras(e.target) },
        { id: 'unidade', fn: (e) => letrasENumeros(e.target) },
        { id: 'tema', fn: (e) => temaPermitido(e.target) },
        { id: 'tipoAula', fn: (e) => apenasLetras(e.target) }
      ];

      validations.forEach(v => {
        const el = document.getElementById(v.id);
        if (el) el.addEventListener('input', v.fn);
      });

      const savedData = sessionStorage.getItem("planoData");
      if (savedData) {
        const data = JSON.parse(savedData);
        Object.keys(data).forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = data[id] || '';
        });
      }
    });
  </script>
</body>
</html>