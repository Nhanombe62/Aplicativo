<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Gerador de Plano Quinzenal</title>
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0066cc;
            --primary-dark: #004c99;
            --bg-color: #f4f6f9;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, .planos-tabela, .planos-tabela td, .planos-tabela th {
            font-family: 'Times New Roman', Times, serif;
        }
        
        .filtros-card, .btn, .filtro-grupo label, .info-item {
            font-family: 'Roboto', sans-serif;
        }
        
        body { background: var(--bg-color); padding: 20px 10px; color: var(--text-color); }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Card Principal */
        .filtros-card {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary-color);
        }

        .filtros-header { text-align: center; margin-bottom: 25px; }
        .filtros-header h3 { color: var(--primary-color); font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .filtros-header p { color: #666; font-size: 14px; }
        
        .linha-localizacao {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .linha-localizacao .filtro-grupo {
            flex: 1;
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .filtro-grupo { display: flex; flex-direction: column; }
        .filtro-grupo.full-width { grid-column: 1 / -1; }
        
        .filtro-grupo label {
            font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #555;
            display: flex; align-items: center; gap: 6px;
        }
        
        input, select {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 15px; background-color: #fafafa;
            transition: all 0.3s ease; outline: none;
        }
        
        input:focus, select:focus {
            border-color: var(--primary-color); background-color: #fff;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .semana-range {
            display: flex; gap: 10px; align-items: center;
            background: #f8f9fa; padding: 10px; border-radius: 8px;
            border: 1px dashed var(--border-color);
        }
        .semana-range span { font-weight: bold; color: #888; font-size: 12px; }
        
        .btn-pesquisar {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white; font-weight: 700; border: none; padding: 15px;
            width: 100%; border-radius: 8px; margin-top: 25px;
            font-size: 16px; cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-pesquisar:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 102, 204, 0.3); }
        
        .temas-transversais {
            background: #e3f2fd; border-left: 5px solid var(--primary-color);
            border-radius: 8px; padding: 20px; margin-bottom: 20px;
        }
        .temas-transversais h4 { font-size: 16px; font-weight: 700; color: var(--primary-dark); margin-bottom: 10px; }
        .temas-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tema-tag {
            background: white; border: 1px solid var(--primary-color);
            color: var(--primary-color); border-radius: 20px;
            padding: 6px 14px; font-size: 13px; font-weight: 600;
        }
        
        .info-plano {
            display: flex; flex-wrap: wrap; gap: 15px; background: white;
            border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 20px;
            border-radius: 8px;
        }
        .info-item {
            flex: 1 1 auto; display: flex; align-items: center; gap: 6px;
            font-weight: 500; color: #555; background: #f8f9fa;
            padding: 8px 12px; border-radius: 6px; font-size: 14px;
        }
        
        /* ESTILO DA TABELA - IGUAL √Ä IMAGEM */
        .planos-tabela {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 20px;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .planos-tabela th {
            background: #333;
            color: white;
            padding: 15px 10px;
            border: 1px solid #444;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
        }
        
        .planos-tabela td {
            border: 1px solid #ddd;
            padding: 15px 12px;
            vertical-align: top;
            color: #333;
            background: #fff;
            font-size: 14px;
            line-height: 1.5;
            transition: background-color 0.2s;
        }
        
        .planos-tabela tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        
        /* MODO EDI√á√ÉO - USANDO CONTENTEDITABLE */
        .modo-edicao td {
            background-color: #fff9e6;
        }
        
        .modo-edicao td[contenteditable="true"] {
            cursor: text;
            outline: none;
            position: relative;
        }
        
        .modo-edicao td[contenteditable="true"]:hover {
            background-color: #fff3cd;
        }
        
        .modo-edicao td[contenteditable="true"]:focus {
            background-color: #fff3cd;
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }
        
        /* C√©lulas n√£o edit√°veis (cabe√ßalho) */
        .planos-tabela th {
            user-select: none;
        }
        
        .acoes {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            min-width: 140px;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn-editar { background: #ffc107; color: #333; }
        .btn-pdf { background: #dc3545; color: white; }
        .btn-salvar { background: #28a745; color: white; }
        .btn-cancelar { background: #6c757d; color: white; }
        .btn-nova-consulta { background: #17a2b8; color: white; }
        
        /* Modal de aviso */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-aviso {
            background: white;
            border-radius: var(--radius);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow);
            border-top: 8px solid #ffc107;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-aviso h2 {
            color: #856404;
            margin-bottom: 20px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-aviso p {
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .modal-aviso .destaque {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid var(--primary-color);
        }
        
        .modal-aviso .destaque strong {
            color: var(--primary-dark);
            font-size: 18px;
        }
        
        .modal-aviso .btn-ok {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            transition: all 0.2s;
        }
        
        .modal-aviso .btn-ok:hover {
            background: #218838;
            transform: scale(1.02);
        }
        
        /* SELETOR DE VARIANTE - POSICIONADO ABAIXO DA DISCIPLINA */
        .variante-container {
            display: none;
            margin-top: 10px;
            margin-bottom: 5px;
            width: 100%;
        }
        
        .variante-box {
            background: #f0f7ff;
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .variante-box label {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 14px;
            white-space: nowrap;
        }
        
        .opcoes-variante {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .opcao-variante {
            padding: 8px 25px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 14px;
        }
        
        .opcao-variante:hover {
            background: #e3f2fd;
            border-color: var(--primary-color);
        }
        
        .opcao-variante.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
        }
        
        .codigo-section {
            background: #e6f0ff;
            border: 2px solid #a0c4ff;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .codigo-destaque {
            background: linear-gradient(135deg, #2b5dab, #1a4a8a);
            color: white;
            font-size: 32px;
            font-weight: bold;
            font-family: monospace;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            letter-spacing: 4px;
            border: 2px solid #ffd700;
            text-align: center;
        }
        
        .input-codigo {
            width: 100%;
            padding: 14px;
            margin-top: 4px;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            font-size: 22px;
            font-family: "Times New Roman", Times, serif;
            text-align: center;
            letter-spacing: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .input-codigo:focus {
            border-color: #2b5dab;
            outline: none;
        }
        
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            width: 0%;
            height: 30px;
            background: linear-gradient(90deg, #2b5dab, #4a7fd4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .mensagem-codigo {
            font-size: 14px;
            word-break: break-word;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        
        .erro-card {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            padding: 30px;
            text-align: center;
            color: #c53030;
            border-radius: var(--radius);
        }

        .hidden {
            display: none !important;
        }
        
        .plano-mz-titulo {
            text-align: center;
            color: #2b5dab;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: 'Times New Roman', Times, serif;
        }
        
        .plano-mz-subtitulo {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* Estilo para o conte√∫do da tabela */
        .visualizacao {
            white-space: pre-line;
            min-height: 40px;
        }

        @media print {
            .filtros-card, .acoes, .modal-overlay { display: none !important; }
            body { background: white; padding: 0; }
            .container { max-width: 100%; }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Modal de Aviso -->
    <div id="modalAviso" class="modal-overlay">
        <div class="modal-aviso">
            <h2>‚ö†Ô∏è Aten√ß√£o Professor!</h2>
            <p>Todas disciplinas est√£o com conte√∫dos actualizados, mas existem:</p>
            <ul style="margin-left: 20px; margin-bottom: 15px; color: #666;">
                <li>üìå Disciplinas em falta</li>
                <li>üìå Disciplinas que os conte√∫dos ainda n√£o est√£o dispon√≠veis</li>
            </ul>
            <p>Estamos a trabalhar para disponibilizar todos os conte√∫dos o mais breve poss√≠vel.</p>
            
            <div class="destaque">
                <strong>‚úÖ Para o 1¬∫ Trimestre de 1¬™ a 6¬™ Classe:</strong>
                <p style="margin-top: 10px; color: var(--primary-dark);">Todas disciplinas est√£o dispon√≠veis e actualizadas!</p>
            </div>
            
            <button class="btn-ok" onclick="fecharModal()">OK, ENTENDI</button>
        </div>
    </div>

    <div class="container">
        <div class="filtros-card" id="filtrosCard">
            <div class="filtros-header">
                <h3>üìù Dados para gerar Plano Quinzenal</h3>
                <p>Preencha as informa√ß√µes locais e selecione o conte√∫do pedag√≥gico.</p>
            </div>
            
            <div class="linha-localizacao">
                <div class="filtro-grupo">
                    <label>üìç Prov√≠ncia</label>
                    <select id="provincia" onchange="carregarDistritos()">
                        <option value="">Selecione a Prov√≠ncia</option>
                        <option value="Niassa">Niassa</option>
                        <option value="Cabo Delgado">Cabo Delgado</option>
                        <option value="Nampula">Nampula</option>
                        <option value="Zamb√©zia">Zamb√©zia</option>
                        <option value="Tete">Tete</option>
                        <option value="Manica">Manica</option>
                        <option value="Sofala">Sofala</option>
                        <option value="Inhambane">Inhambane</option>
                        <option value="Gaza">Gaza</option>
                        <option value="Maputo Prov√≠ncia">Maputo Prov√≠ncia</option>
                        <option value="Maputo Cidade">Maputo Cidade</option>
                    </select>
                </div>
                
                <div class="filtro-grupo">
                    <label>üèõÔ∏è Distrito</label>
                    <select id="distrito">
                        <option value="">Primeiro selecione a prov√≠ncia</option>
                    </select>
                </div>
            </div>
            
            <div class="filtros-grid">
                <div class="filtro-grupo">
                    <label>üéì Classe</label>
                    <select id="classe" onchange="carregarDisciplinas(); verificarVariante()">
                        <option value="">Selecione a classe</option>
                        <option value="1¬™ Classe">1¬™ Classe</option>
                        <option value="2¬™ Classe">2¬™ Classe</option>
                        <option value="3¬™ Classe">3¬™ Classe</option>
                        <option value="4¬™ Classe">4¬™ Classe</option>
                        <option value="5¬™ Classe">5¬™ Classe</option>
                        <option value="6¬™ Classe">6¬™ Classe</option>
                        <option value="7¬™ Classe">7¬™ Classe</option>
                        <option value="8¬™ Classe">8¬™ Classe</option>
                        <option value="9¬™ Classe">9¬™ Classe</option>
                        <option value="10¬™ Classe">10¬™ Classe</option>
                        <option value="11¬™ Classe">11¬™ Classe</option>
                        <option value="12¬™ Classe">12¬™ Classe</option>
                    </select>
                </div>
                
                <div class="filtro-grupo" style="position: relative;">
                    <label>üìñ Disciplina</label>
                    <select id="disciplina" onchange="verificarVariante()">
                        <option value="">Primeiro selecione a classe</option>
                    </select>
                    
                    <!-- SELETOR DE VARIANTE - POSICIONADO ABAIXO DA DISCIPLINA -->
                    <div id="varianteContainer" class="variante-container">
                        <div class="variante-box">
                            <label>üî¢ Variante:</label>
                            <div class="opcoes-variante">
                                <div class="opcao-variante" onclick="selecionarVariante('Letra')" id="varLetra">üìù Letras</div>
                                <div class="opcao-variante" onclick="selecionarVariante('Ci√™ncias')" id="varCiencias">üî¨ Ci√™ncias</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="filtro-grupo">
                    <label>üìÖ Trimestre</label>
                    <select id="trimestre">
                        <option value="">Selecione o trimestre</option>
                        <option value="1¬∫ Trimestre">1¬∫ Trimestre</option>
                        <option value="2¬∫ Trimestre">2¬∫ Trimestre</option>
                        <option value="3¬∫ Trimestre">3¬∫ Trimestre</option>
                    </select>
                </div>
                
                <div class="filtro-grupo full-width">
                    <label>üè´ Nome da Escola</label>
                    <input type="text" id="nomeEscola" placeholder="Digite o nome completo da escola">
                </div>
                
                <div class="filtro-grupo full-width">
                    <label>üìÜ Per√≠odo de Vig√™ncia (M√°x. 3 semanas)</label>
                    <div class="semana-range">
                        <select id="semanaInicio" onchange="validarSemanas()">
                            <option value="">Semana inicial</option>
                            <option value="1¬™ Semana">1¬™ Semana</option>
                            <option value="2¬™ Semana">2¬™ Semana</option>
                            <option value="3¬™ Semana">3¬™ Semana</option>
                            <option value="4¬™ Semana">4¬™ Semana</option>
                            <option value="5¬™ Semana">5¬™ Semana</option>
                            <option value="6¬™ Semana">6¬™ Semana</option>
                            <option value="7¬™ Semana">7¬™ Semana</option>
                            <option value="8¬™ Semana">8¬™ Semana</option>
                            <option value="9¬™ Semana">9¬™ Semana</option>
                            <option value="10¬™ Semana">10¬™ Semana</option>
                            <option value="11¬™ Semana">11¬™ Semana</option>
                            <option value="12¬™ Semana">12¬™ Semana</option>
                            <option value="13¬™ Semana">13¬™ Semana</option>
                            <option value="14¬™ Semana">14¬™ Semana</option>
                        </select>
                        <span>at√©</span>
                        <select id="semanaFim" onchange="validarSemanas()">
                            <option value="">Semana final</option>
                            <option value="1¬™ Semana">1¬™ Semana</option>
                            <option value="2¬™ Semana">2¬™ Semana</option>
                            <option value="3¬™ Semana">3¬™ Semana</option>
                            <option value="4¬™ Semana">4¬™ Semana</option>
                            <option value="5¬™ Semana">5¬™ Semana</option>
                            <option value="6¬™ Semana">6¬™ Semana</option>
                            <option value="7¬™ Semana">7¬™ Semana</option>
                            <option value="8¬™ Semana">8¬™ Semana</option>
                            <option value="9¬™ Semana">9¬™ Semana</option>
                            <option value="10¬™ Semana">10¬™ Semana</option>
                            <option value="11¬™ Semana">11¬™ Semana</option>
                            <option value="12¬™ Semana">12¬™ Semana</option>
                            <option value="13¬™ Semana">13¬™ Semana</option>
                            <option value="14¬™ Semana">14¬™ Semana</option>
                        </select>
                    </div>
                    <div id="erroSemanas" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;">
                        ‚ö†Ô∏è O per√≠odo n√£o pode ultrapassar 3 semanas
                    </div>
                </div>
            </div>
            
            <button class="btn-pesquisar" onclick="gerarPlanoQuinzenal()">
                <span>üìã</span> GERAR PLANO QUINZENAL
            </button>
        </div>
        
        <div id="resultadoContainer"></div>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyClUaP2QpNFnCNwh449i0ztzzSnBj8CWG4",
            authDomain: "plano-de-aula-moz.firebaseapp.com",
            projectId: "plano-de-aula-moz",
            storageBucket: "plano-de-aula-moz.firebasestorage.app",
            messagingSenderId: "710741933182",
            appId: "1:710741933182:web:f3599eb809e31fe3eeec2f"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let planosAtuais = [];
        let planosOriginais = [];
        let codigoAtual = "";
        let varianteSelecionada = "";
        let idiomaAtual = "pt";
        let modoEdicaoAtivo = false;

        // Controle do modal de aviso
        window.onload = function() {
            if (!sessionStorage.getItem('avisoMostrado')) {
                document.getElementById('modalAviso').style.display = 'flex';
                sessionStorage.setItem('avisoMostrado', 'true');
            } else {
                document.getElementById('modalAviso').style.display = 'none';
            }
        }

        function fecharModal() {
            document.getElementById('modalAviso').style.display = 'none';
        }

        // DADOS DOS DISTRITOS
        const distritosPorProvincia = {
            "Niassa": ["Cuamba", "Lago", "Lichinga", "Majune", "Mandimba", "Marrupa", "Ma√∫a", "Mavago", "Mecanhelas", "Mecula", "Metarica", "Muembe", "N'gauma", "Nipepe", "Sanga"],
            "Cabo Delgado": ["Ancuabe", "Balama", "Chi√∫re", "Ibo", "Macomia", "Mec√∫fi", "Meluco", "Moc√≠mboa da Praia", "Montepuez", "Mueda", "Muidumbe", "Namuno", "Nangade", "Palma", "Pemba", "Quissanga"],
            "Nampula": ["Angoche", "Er√°ti", "Ilha de Mo√ßambique", "Lalaua", "Larde", "Li√∫po", "Malema", "Meconta", "Mecub√∫ri", "Memba", "Mogincual", "Mogovolas", "Moma", "Monapo", "Mossuril", "Muecate", "Murrupula", "Nacala", "Nacala-a-Velha", "Nacar√¥a", "Nampula", "Rapale", "Rib√°u√®"],
            "Zamb√©zia": ["Alto Mol√≥cu√®", "Chinde", "Gile", "Guru√©", "Ile", "Inhassunge", "Luabo", "Maganja da Costa", "Milange", "Mocuba", "Mopeia", "Morrumbala", "Namacurra", "Namarroi", "Nicoadala", "Pebane", "Quelimane"],
            "Tete": ["Ang√≥nia", "Cahora-Bassa", "Changara", "Chifunde", "Chiuta", "M√°go√®", "Mar√°via", "Moatize", "Mutarara", "Tsangano", "Zumbo"],
            "Manica": ["Baru√©", "Gondola", "Guro", "Macate", "Machaze", "Macossa", "Manica", "Mossurize", "Sussundenga", "Tambara", "Vanduzi"],
            "Sofala": ["B√∫zi", "Caia", "Chemba", "Cheringoma", "Chibabava", "Dondo", "Gorongosa", "Machanga", "Maringu√©", "Marromeu", "Muanza", "Nhamatanda"],
            "Inhambane": ["Funhalouro", "Govuro", "Homo√≠ne", "Inhambane", "Inharrime", "Inhassoro", "Jangamo", "Mabote", "Massinga", "Maxixe", "Morrumbene", "Panda", "Vilankulo", "Zavala"],
            "Gaza": ["Bilene", "Chibuto", "Chicualacuala", "Chigubo", "Ch√≥kw√®", "Guij√°", "Limpopo", "Mabalane", "Manjacaze", "Mapai", "Massingir", "Xai-Xai"],
            "Maputo Prov√≠ncia": ["Boane", "Magude", "Manhi√ßa", "Marracuene", "Matola", "Matutu√≠ne", "Moamba", "Namaacha"],
            "Maputo Cidade": ["KaMpfumo", "Nlhamankulu", "KaMaxaquene", "KaMavota", "KaMubukwana", "KaTembe", "KaNyaka"]
        };

        // DISCIPLINAS POR CLASSE
        const disciplinasPorClasse = {
            "1¬™ Classe": ["Portugu√™s", "Matem√°tica", "Educa√ß√£o F√≠sica"],
            "2¬™ Classe": ["Portugu√™s", "Matem√°tica", "Educa√ß√£o F√≠sica"],
            "3¬™ Classe": ["Portugu√™s", "Matem√°tica", "Educa√ß√£o F√≠sica"],
            "4¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ci√™ncias Sociais", "Ci√™ncias Naturais", "Educa√ß√£o F√≠sica"],
            "5¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ci√™ncias Naturais", "Ci√™ncias Sociais", "Educa√ß√£o Visual", "Educa√ß√£o F√≠sica"],
            "6¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ci√™ncias Naturais", "Ci√™ncias Sociais", "Educa√ß√£o Visual", "Educa√ß√£o F√≠sica"],
            "7¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ingl√™s", "Hist√≥ria", "Geografia", "Biologia", "Educa√ß√£o F√≠sica", "TICs", "Agropecu√°ria", "F√≠sica"],
            "8¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ingl√™s", "Hist√≥ria", "Geografia", "Biologia", "Educa√ß√£o F√≠sica", "TICs", "Agropecu√°ria", "F√≠sica"],
            "9¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ingl√™s", "Hist√≥ria", "Geografia", "Biologia", "F√≠sica", "Qu√≠mica", "Educa√ß√£o F√≠sica", "Franc√™s", "TICs", "Agropecu√°ria"],
            "10¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ingl√™s", "Hist√≥ria", "Geografia", "Biologia", "F√≠sica", "Qu√≠mica", "Educa√ß√£o F√≠sica", "Franc√™s", "Filosofia"],
            "11¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ingl√™s", "Hist√≥ria", "Geografia", "Biologia", "F√≠sica", "Qu√≠mica", "Educa√ß√£o F√≠sica", "Franc√™s", "Filosofia", "TICs", "Desenho e Geometria Descritiva"],
            "12¬™ Classe": ["Portugu√™s", "Matem√°tica", "Ingl√™s", "Hist√≥ria", "Geografia", "Biologia", "F√≠sica", "Qu√≠mica", "Educa√ß√£o F√≠sica", "Franc√™s", "Filosofia", "Psicologia", "TICs"]
        };

        function carregarDistritos() {
            const provincia = document.getElementById('provincia').value;
            const distritoSelect = document.getElementById('distrito');
            distritoSelect.innerHTML = '';
            if (!provincia) {
                distritoSelect.innerHTML = '<option value="">Primeiro selecione a prov√≠ncia</option>';
                return;
            }
            const distritos = distritosPorProvincia[provincia] || [];
            distritoSelect.innerHTML = '<option value="">Selecione o distrito</option>';
            distritos.sort().forEach(distrito => {
                const option = document.createElement('option');
                option.value = distrito;
                option.textContent = distrito;
                distritoSelect.appendChild(option);
            });
        }

        function carregarDisciplinas() {
            const classe = document.getElementById('classe').value;
            const disciplinaSelect = document.getElementById('disciplina');
            disciplinaSelect.innerHTML = '';
            if (!classe) {
                disciplinaSelect.innerHTML = '<option value="">Primeiro selecione a classe</option>';
                return;
            }
            const disciplinas = disciplinasPorClasse[classe] || [];
            disciplinaSelect.innerHTML = '<option value="">Selecione a disciplina</option>';
            disciplinas.sort().forEach(disciplina => {
                const option = document.createElement('option');
                option.value = disciplina;
                option.textContent = disciplina;
                disciplinaSelect.appendChild(option);
            });
        }

        function verificarVariante() {
            const classe = document.getElementById('classe').value;
            const disciplina = document.getElementById('disciplina').value;
            const varianteContainer = document.getElementById('varianteContainer');
            
            if ((classe === '11¬™ Classe' || classe === '12¬™ Classe') && disciplina === 'Matem√°tica') {
                varianteContainer.style.display = 'block';
                document.getElementById('varLetra').classList.remove('selected');
                document.getElementById('varCiencias').classList.remove('selected');
                varianteSelecionada = "";
            } else {
                varianteContainer.style.display = 'none';
                varianteSelecionada = "";
            }
        }

        function selecionarVariante(variante) {
            varianteSelecionada = variante;
            document.getElementById('varLetra').classList.remove('selected');
            document.getElementById('varCiencias').classList.remove('selected');
            document.getElementById(`var${variante}`).classList.add('selected');
        }

        function validarSemanas() {
            const inicio = document.getElementById('semanaInicio').value;
            const fim = document.getElementById('semanaFim').value;
            const erroDiv = document.getElementById('erroSemanas');
            if (!inicio || !fim) {
                erroDiv.style.display = 'none';
                return true;
            }
            const numInicio = extrairNumeroSemana(inicio);
            const numFim = extrairNumeroSemana(fim);
            if (numFim - numInicio > 2) {
                erroDiv.style.display = 'block';
                return false;
            } else {
                erroDiv.style.display = 'none';
                return true;
            }
        }

        function extrairNumeroSemana(semana) {
            if (!semana) return 0;
            const match = semana.match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        function extrairTemasTransversais(planos) {
            const temasSet = new Set();
            planos.forEach(plano => {
                const temas = plano.TemasTransversais || plano.temasTransversais;
                if (temas && temas.trim() !== '') {
                    temas.split(',').map(t => t.trim()).forEach(t => { if (t) temasSet.add(t); });
                }
            });
            return Array.from(temasSet);
        }

        function obterPeriodo(semana) {
            const periodos = {
                "1¬™ Semana": "02/03 a 06/03",
                "2¬™ Semana": "09/03 a 13/03",
                "3¬™ Semana": "16/03 a 20/03",
                "4¬™ Semana": "23/03 a 27/03",
                "5¬™ Semana": "30/03 a 03/04",
                "6¬™ Semana": "06/04 a 10/04",
                "7¬™ Semana": "13/04 a 17/04",
                "8¬™ Semana": "20/04 a 24/04",
                "9¬™ Semana": "27/04 a 01/05",
                "10¬™ Semana": "04/05 a 08/05",
                "11¬™ Semana": "11/05 a 15/05",
                "12¬™ Semana": "18/05 a 22/05",
                "13¬™ Semana": "25/05 a 29/05",
                "14¬™ Semana": "01/06 a 05/06"
            };
            return periodos[semana] || semana;
        }

        function formatarComMarcadores(texto) {
            if (!texto) return '-';
            texto = String(texto);
            const partes = texto.split(';').map(p => p.trim()).filter(p => p);
            if (partes.length === 0) return '-';
            if (partes.length === 1) return `- ${partes[0]}`;
            return partes.map(p => `- ${p}`).join('\n');
        }

        function formatarClasse(classe) {
            if (!classe) return null;
            const mapa = {
                "1¬™ Classe": "1a", "2¬™ Classe": "2a", "3¬™ Classe": "3a", "4¬™ Classe": "4a",
                "5¬™ Classe": "5a", "6¬™ Classe": "6a", "7¬™ Classe": "7a", "8¬™ Classe": "8a",
                "9¬™ Classe": "9a", "10¬™ Classe": "10a", "11¬™ Classe": "11a", "12¬™ Classe": "12a"
            };
            return mapa[classe] || classe;
        }

        function formatarTrimestre(trimestre) {
            if (!trimestre) return null;
            const match = trimestre.match(/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }

        function normalizarPlano(plano) {
            return {
                semana: plano.Semana || plano.semana,
                unidadeTematica: plano.UnidadeTematica || plano.unidadeTematica,
                objetivos: plano.Objectivos || plano.objetivos,
                conteudo: plano.Conteudo || plano.conteudo || plano.Tema || plano.tema,
                temasTransversais: plano.TemasTransversais || plano.temasTransversais,
                cargaHoraria: plano.CargaHoraria || plano.cargaHoraria,
                disciplina: plano.Disciplina || plano.disciplina,
                classe: plano.Classe || plano.classe,
                trimestre: plano.Trimestre || plano.trimestre
            };
        }

        function validarFiltros() {
            const provincia = document.getElementById('provincia').value;
            const distrito = document.getElementById('distrito').value;
            const classe = document.getElementById('classe').value;
            const disciplina = document.getElementById('disciplina').value;
            const trimestre = document.getElementById('trimestre').value;
            const inicio = document.getElementById('semanaInicio').value;
            const fim = document.getElementById('semanaFim').value;
            
            if ((classe === '11¬™ Classe' || classe === '12¬™ Classe') && disciplina === 'Matem√°tica' && !varianteSelecionada) {
                alert('‚ö†Ô∏è Por favor, selecione a variante de Matem√°tica (Letras ou Ci√™ncias).');
                return false;
            }
            
            if (!provincia) { alert('‚ö†Ô∏è Selecione a Prov√≠ncia.'); return false; }
            if (!distrito) { alert('‚ö†Ô∏è Selecione o Distrito.'); return false; }
            if (!classe) { alert('‚ö†Ô∏è Selecione a CLASSE.'); return false; }
            if (!disciplina) { alert('‚ö†Ô∏è Selecione a DISCIPLINA.'); return false; }
            if (!trimestre) { alert('‚ö†Ô∏è Selecione o TRIMESTRE.'); return false; }
            if (!inicio || !fim) { alert('‚ö†Ô∏è Selecione o per√≠odo de semanas.'); return false; }
            if (!validarSemanas()) { alert('‚ö†Ô∏è O per√≠odo n√£o pode ultrapassar 3 semanas.'); return false; }
            return true;
        }

        function gerarCodigoAleatorio() {
            const prefixos = ['MZ', 'PL', 'AU', 'AL', 'UN', 'ZA', 'ES', 'PR', 'MO', 'CM'];
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            const prefixo = prefixos[Math.floor(Math.random() * prefixos.length)];
            let codigo = prefixo;
            for (let i = 0; i < 4; i++) {
                codigo += chars[Math.floor(Math.random() * chars.length)];
            }
            return codigo;
        }

        function simularProgresso() {
            const pc = document.getElementById("progressContainer");
            const pb = document.getElementById("progressBar");
            const pt = document.getElementById("progressText");
            pc.style.display = "block";
            let p = 0;
            const i = setInterval(() => {
                p += 2;
                pb.style.width = p + "%";
                pt.textContent = p + "%";
                if (p >= 100) clearInterval(i);
            }, 30);
        }

        async function gerarPlanoQuinzenal() {
            if (!validarFiltros()) return;
            
            const resultadoContainer = document.getElementById('resultadoContainer');
            resultadoContainer.innerHTML = '<div class="loading">‚è≥ Processando dados...</div>';
            document.getElementById('filtrosCard').style.display = 'none';
            
            try {
                const classeOriginal = document.getElementById('classe').value;
                const classeFormatada = formatarClasse(classeOriginal);
                let disciplina = document.getElementById('disciplina').value;
                
                if ((classeOriginal === '11¬™ Classe' || classeOriginal === '12¬™ Classe') && disciplina === 'Matem√°tica' && varianteSelecionada) {
                    disciplina = `Matem√°tica (${varianteSelecionada})`;
                }
                
                const trimestreOriginal = document.getElementById('trimestre').value;
                const trimestreNum = formatarTrimestre(trimestreOriginal);
                const semanaInicio = document.getElementById('semanaInicio').value;
                const semanaFim = document.getElementById('semanaFim').value;
                const provincia = document.getElementById('provincia').value;
                const distrito = document.getElementById('distrito').value;
                const nomeEscola = document.getElementById('nomeEscola').value || "Escola Sem Nome";

                if (disciplina.includes('Franc√™s')) idiomaAtual = 'fr';
                else if (disciplina.includes('Ingl√™s')) idiomaAtual = 'en';
                else idiomaAtual = 'pt';

                const snapshot = await db.collection('planos')
                    .where('Classe', '==', classeFormatada)
                    .where('Disciplina', '==', disciplina)
                    .where('Trimestre', '==', trimestreNum)
                    .where('Ano', '==', 2026)
                    .get();
                
                if (snapshot.empty) {
                    resultadoContainer.innerHTML = `
                        <div class="erro-card">
                            <h3>‚ö†Ô∏è Nenhum plano encontrado</h3>
                            <p>N√£o existem registos para ${classeOriginal} - ${disciplina}</p>
                            <br>
                            <button class="btn btn-nova-consulta" onclick="mostrarFiltros()" style="margin: 0 auto;">üîÑ VOLTAR</button>
                        </div>`;
                    return;
                }

                const numInicio = extrairNumeroSemana(semanaInicio);
                const numFim = extrairNumeroSemana(semanaFim);
                
                planosAtuais = [];                
                snapshot.forEach(doc => {
                    const plano = doc.data();
                    const semana = plano.Semana || plano.semana;
                    const numSemana = extrairNumeroSemana(semana);
                    if (numSemana >= numInicio && numSemana <= numFim) {
                        planosAtuais.push(normalizarPlano(plano));
                    }
                });

                planosAtuais.sort((a, b) => extrairNumeroSemana(a.semana) - extrairNumeroSemana(b.semana));

                if (planosAtuais.length === 0) {
                    resultadoContainer.innerHTML = `
                        <div class="erro-card">
                            <h3>‚ö†Ô∏è Per√≠odo vazio</h3>
                            <p>Nenhum plano nas semanas selecionadas.</p>
                            <br>
                            <button class="btn btn-nova-consulta" onclick="mostrarFiltros()" style="margin: 0 auto;">üîÑ VOLTAR</button>
                        </div>`;
                    return;
                }

                planosOriginais = JSON.parse(JSON.stringify(planosAtuais));
                const temasLista = extrairTemasTransversais(planosAtuais);
                
                mostrarInterfacePlano(provincia, distrito, nomeEscola, classeOriginal, disciplina, trimestreOriginal, semanaInicio, semanaFim, temasLista);

            } catch (error) {
                console.error(error);
                resultadoContainer.innerHTML = `<div class="erro-card">‚ùå Erro: ${error.message}</div>`;
            }
        }

        function mostrarInterfacePlano(provincia, distrito, nomeEscola, classe, disciplina, trimestre, semanaInicio, semanaFim, temasLista) {
            const resultadoContainer = document.getElementById('resultadoContainer');
            
            let temasHTML = temasLista.length > 0 
                ? `<div class="temas-transversais">
                    <h4>üìå ${idiomaAtual === 'fr' ? 'TH√àMES TRANSVERSAUX' : idiomaAtual === 'en' ? 'CROSS-CUTTING THEMES' : 'TEMAS TRANSVERSAIS'}</h4>
                    <div class="temas-tags">${temasLista.map(t => `<span class="tema-tag">${t}</span>`).join('')}</div>
                   </div>`
                : `<div class="temas-transversais" style="background:#fff3cd;border-left-color:#856404;">
                    <h4 style="color:#856404;">‚ÑπÔ∏è ${idiomaAtual === 'fr' ? 'INFORMATION' : idiomaAtual === 'en' ? 'INFORMATION' : 'INFORMA√á√ÉO'}</h4>
                    <p style="text-align:center; color:#856404;">${idiomaAtual === 'fr' ? 'Aucun th√®me transversal enregistr√©' : idiomaAtual === 'en' ? 'No cross-cutting theme recorded' : 'Nenhum tema transversal registado'}</p>
                   </div>`;
            
            const periodoInicio = obterPeriodo(semanaInicio);
            const periodoFim = obterPeriodo(semanaFim);
            
            resultadoContainer.innerHTML = `
                ${temasHTML}                
                <div class="info-plano">
                    <span class="info-item">üìç <strong>${idiomaAtual === 'fr' ? 'Prov' : idiomaAtual === 'en' ? 'Prov' : 'Prov'}:</strong> ${provincia}</span>
                    <span class="info-item">üèõÔ∏è <strong>${idiomaAtual === 'fr' ? 'Dist' : idiomaAtual === 'en' ? 'Dist' : 'Dist'}:</strong> ${distrito}</span>
                    <span class="info-item">üè´ <strong>${idiomaAtual === 'fr' ? '√âcole' : idiomaAtual === 'en' ? 'School' : 'Escola'}:</strong> ${nomeEscola}</span>
                    <span class="info-item">üéì <strong>${idiomaAtual === 'fr' ? 'Classe' : idiomaAtual === 'en' ? 'Class' : 'Classe'}:</strong> ${classe}</span>
                    <span class="info-item">üìñ <strong>${idiomaAtual === 'fr' ? 'Discipline' : idiomaAtual === 'en' ? 'Subject' : 'Disciplina'}:</strong> ${disciplina}</span>
                    <span class="info-item">üìÖ <strong>${idiomaAtual === 'fr' ? 'Trimestre' : idiomaAtual === 'en' ? 'Term' : 'Trimestre'}:</strong> ${trimestre}</span>
                    <span class="info-item">üìÜ <strong>${idiomaAtual === 'fr' ? 'P√©riode' : idiomaAtual === 'en' ? 'Period' : 'Vig√™ncia'}:</strong> ${periodoInicio} √† ${periodoFim}</span>
                </div>
                <div id="tabelaContainer"></div>
                <div class="acoes">
                    <button class="btn btn-editar" onclick="habilitarEdicao()">‚úèÔ∏è ${idiomaAtual === 'fr' ? '√âDITER' : idiomaAtual === 'en' ? 'EDIT' : 'EDITAR'}</button>
                    <button class="btn btn-pdf" onclick="mostrarCodigoAcesso()">üì• ${idiomaAtual === 'fr' ? 'T√âL√âCHARGER PDF' : idiomaAtual === 'en' ? 'DOWNLOAD PDF' : 'BAIXAR PDF'}</button>
                    <button class="btn btn-nova-consulta" onclick="mostrarFiltros()">üîç ${idiomaAtual === 'fr' ? 'NOUVELLE RECHERCHE' : idiomaAtual === 'en' ? 'NEW SEARCH' : 'NOVA PESQUISA'}</button>
                </div>
            `;
            
            window.planosParaEdicao = planosAtuais;
            window.planosOriginaisEdicao = JSON.parse(JSON.stringify(planosAtuais));
            
            mostrarTabelaPlanos(planosAtuais, false);
        }

        function mostrarTabelaPlanos(planos, modoEdicao = false) {
            const tabelaContainer = document.getElementById('tabelaContainer');
            
            let tituloSemana, tituloUnidade, tituloObjetivos, tituloConteudos, tituloTemas, tituloCH;
            
            if (idiomaAtual === 'fr') {
                tituloSemana = 'Semaine';
                tituloUnidade = 'Unit√© Th√©matique';
                tituloObjetivos = 'Objectifs Sp√©cifiques';
                tituloConteudos = 'Contenus';
                tituloTemas = 'Th√®mes Trans.';
                tituloCH = 'C.H.';
            } else if (idiomaAtual === 'en') {
                tituloSemana = 'Week';
                tituloUnidade = 'Thematic Unit';
                tituloObjetivos = 'Specific Objectives';
                tituloConteudos = 'Contents';
                tituloTemas = 'Cross-cutting';
                tituloCH = 'C.H.';
            } else {
                tituloSemana = 'Semana';
                tituloUnidade = 'Unid. Tem√°tica';
                tituloObjetivos = 'Objectivos';
                tituloConteudos = 'Conte√∫dos';
                tituloTemas = 'Temas Trans.';
                tituloCH = 'C.H.';
            }
            
            let html = `<table class="planos-tabela ${modoEdicao ? 'modo-edicao' : ''}" id="tabelaPlanos"><thead><tr>
                <th style="width: 8%">${tituloSemana}</th>
                <th style="width: 14%">${tituloUnidade}</th>
                <th style="width: 24%">${tituloObjetivos}</th>
                <th style="width: 24%">${tituloConteudos}</th>
                <th style="width: 18%">${tituloTemas}</th>
                <th style="width: 12%">${tituloCH}</th>
            </tr></thead><tbody>`;
            
            planos.forEach((plano, index) => {
                html += `<tr>`;
                
                // Semana - edit√°vel apenas em modo edi√ß√£o
                html += `<td ${modoEdicao ? 'contenteditable="true" data-index="' + index + '" data-campo="semana"' : ''}>${plano.semana || '-'}</td>`;
                
                // Unidade Tem√°tica
                html += `<td ${modoEdicao ? 'contenteditable="true" data-index="' + index + '" data-campo="unidadeTematica"' : ''}>${plano.unidadeTematica || '-'}</td>`;
                
                // Objectivos (preservar marcadores)
                html += `<td ${modoEdicao ? 'contenteditable="true" data-index="' + index + '" data-campo="objetivos"' : ''} style="white-space:pre-line;">${modoEdicao ? (plano.objetivos || '') : formatarComMarcadores(plano.objetivos)}</td>`;
                
                // Conte√∫dos
                html += `<td ${modoEdicao ? 'contenteditable="true" data-index="' + index + '" data-campo="conteudo"' : ''} style="white-space:pre-line;">${modoEdicao ? (plano.conteudo || '') : formatarComMarcadores(plano.conteudo)}</td>`;
                
                // Temas Transversais
                html += `<td ${modoEdicao ? 'contenteditable="true" data-index="' + index + '" data-campo="temasTransversais"' : ''}>${modoEdicao ? (plano.temasTransversais || '') : formatarComMarcadores(plano.temasTransversais)}</td>`;
                
                // Carga Hor√°ria
                html += `<td ${modoEdicao ? 'contenteditable="true" data-index="' + index + '" data-campo="cargaHoraria" style="text-align:center;"' : 'style="text-align:center;"'}>${plano.cargaHoraria || '-'}</td>`;
                
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            tabelaContainer.innerHTML = html;
            
            modoEdicaoAtivo = modoEdicao;
        }

        function habilitarEdicao() {
            // Ativar modo de edi√ß√£o na tabela principal com contenteditable
            mostrarTabelaPlanos(planosAtuais, true);
            
            // Atualizar bot√µes
            document.querySelector('.acoes').innerHTML = `
                <button class="btn btn-salvar" onclick="salvarEdicao()">üíæ ${idiomaAtual === 'fr' ? 'SAUVEGARDER' : idiomaAtual === 'en' ? 'SAVE' : 'SALVAR'}</button>
                <button class="btn btn-cancelar" onclick="cancelarEdicao()">‚ùå ${idiomaAtual === 'fr' ? 'ANNULER' : idiomaAtual === 'en' ? 'CANCEL' : 'CANCELAR'}</button>
                <button class="btn btn-nova-consulta" onclick="mostrarFiltros()">üîç ${idiomaAtual === 'fr' ? 'RETOUR' : idiomaAtual === 'en' ? 'BACK' : 'VOLTAR'}</button>
            `;
        }

        function salvarEdicao() {
            // Coletar todos os valores editados via contenteditable
            const cells = document.querySelectorAll('[contenteditable="true"]');
            cells.forEach(cell => {
                const index = cell.getAttribute('data-index');
                const campo = cell.getAttribute('data-campo');
                if (index !== null && campo !== null && planosAtuais[index]) {
                    planosAtuais[index][campo] = cell.innerText.trim();
                }
            });
            
            // Atualizar originais com as altera√ß√µes
            planosOriginais = JSON.parse(JSON.stringify(planosAtuais));
            
            // Sair do modo edi√ß√£o
            cancelarEdicao();
            
            alert(idiomaAtual === 'fr' ? "‚úÖ Modifications enregistr√©es!" : 
                  idiomaAtual === 'en' ? "‚úÖ Changes saved!" : 
                  "‚úÖ Altera√ß√µes salvas!");
        }

        function cancelarEdicao() {
            // Restaurar os dados originais
            planosAtuais = JSON.parse(JSON.stringify(planosOriginais));
            
            // Voltar ao modo visualiza√ß√£o
            mostrarTabelaPlanos(planosAtuais, false);
            
            // Restaurar bot√µes
            document.querySelector('.acoes').innerHTML = `
                <button class="btn btn-editar" onclick="habilitarEdicao()">‚úèÔ∏è ${idiomaAtual === 'fr' ? '√âDITER' : idiomaAtual === 'en' ? 'EDIT' : 'EDITAR'}</button>
                <button class="btn btn-pdf" onclick="mostrarCodigoAcesso()">üì• ${idiomaAtual === 'fr' ? 'T√âL√âCHARGER PDF' : idiomaAtual === 'en' ? 'DOWNLOAD PDF' : 'BAIXAR PDF'}</button>
                <button class="btn btn-nova-consulta" onclick="mostrarFiltros()">üîç ${idiomaAtual === 'fr' ? 'NOUVELLE RECHERCHE' : idiomaAtual === 'en' ? 'NEW SEARCH' : 'NOVA PESQUISA'}</button>
            `;
        }

        function mostrarFiltros() {
            document.getElementById('filtrosCard').style.display = 'block';
            document.getElementById('resultadoContainer').innerHTML = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function mostrarCodigoAcesso() {
            if (!planosAtuais || planosAtuais.length === 0) {
                alert(idiomaAtual === 'fr' ? '‚ùå Aucun plan disponible' : 
                      idiomaAtual === 'en' ? '‚ùå No plan available' : 
                      '‚ùå Nenhum plano dispon√≠vel');
                return;
            }

            const tabelaContainer = document.getElementById('tabelaContainer');
            const acoes = document.querySelector('.acoes');
            const infoPlano = document.querySelector('.info-plano');
            const temasTransversais = document.querySelector('.temas-transversais');
            
            tabelaContainer.classList.add('hidden');
            acoes.classList.add('hidden');
            if (infoPlano) infoPlano.classList.add('hidden');
            if (temasTransversais) temasTransversais.classList.add('hidden');
            
            codigoAtual = gerarCodigoAleatorio();
            
            const codigoSection = document.createElement('div');
            codigoSection.id = 'codigoSection';
            codigoSection.className = 'codigo-section';
            codigoSection.innerHTML = `
                <div class="plano-mz-titulo">Plano de Aula MZ - ${idiomaAtual === 'fr' ? 'Quinzaine' : idiomaAtual === 'en' ? 'Fortnightly' : 'Quinzenal'}</div>
                <p style="font-weight:bold; text-align:center; margin:20px 0 15px;">üîê ${idiomaAtual === 'fr' ? 'ENTREZ LE CODE' : idiomaAtual === 'en' ? 'ENTER CODE' : 'INSIRA O C√ìDIGO'}</p>
                <div class="codigo-destaque" id="codigoAtual">${codigoAtual}</div>
                <input type="text" id="codigoAcesso" class="input-codigo" placeholder="${idiomaAtual === 'fr' ? 'Code' : idiomaAtual === 'en' ? 'Code' : 'C√≥digo'}" maxlength="8" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
                <div id="mensagemCodigo" class="mensagem-codigo"></div>
                <div class="loading" id="loading" style="display:none;">‚è≥ ${idiomaAtual === 'fr' ? 'Validation...' : idiomaAtual === 'en' ? 'Validating...' : 'Validando...'}</div>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"><span id="progressText">0%</span></div>
                </div>
                <button class="btn btn-pdf" onclick="validarCodigo()" style="margin-top:15px;">‚úÖ ${idiomaAtual === 'fr' ? 'CONFIRMER' : idiomaAtual === 'en' ? 'CONFIRM' : 'CONFIRMAR'}</button>
                <button class="btn btn-cancelar" onclick="cancelarCodigo()" style="margin-top:10px;">‚ùå ${idiomaAtual === 'fr' ? 'ANNULER' : idiomaAtual === 'en' ? 'CANCEL' : 'CANCELAR'}</button>
            `;
            
            document.getElementById('resultadoContainer').appendChild(codigoSection);
        }

        function cancelarCodigo() {
            const codigoSection = document.getElementById('codigoSection');
            if (codigoSection) codigoSection.remove();
            
            document.getElementById('tabelaContainer').classList.remove('hidden');
            document.querySelector('.acoes').classList.remove('hidden');
            document.querySelector('.info-plano')?.classList.remove('hidden');
            document.querySelector('.temas-transversais')?.classList.remove('hidden');
        }

        function validarCodigo() {
            const codigo = document.getElementById("codigoAcesso").value.trim().toUpperCase();
            const msg = document.getElementById("mensagemCodigo");
            const loading = document.getElementById("loading");
            
            if (!codigo) { 
                msg.innerHTML = idiomaAtual === 'fr' ? "‚ö†Ô∏è Entrez le code" : idiomaAtual === 'en' ? "‚ö†Ô∏è Enter code" : "‚ö†Ô∏è Digite o c√≥digo"; 
                return; 
            }
            
            loading.style.display = "block";
            msg.innerHTML = idiomaAtual === 'fr' ? "Validation..." : idiomaAtual === 'en' ? "Validating..." : "Validando...";
            simularProgresso();

            setTimeout(() => {
                if (codigo === codigoAtual) {
                    msg.style.color = "green";
                    msg.innerHTML = idiomaAtual === 'fr' ? "‚úÖ Code valide! G√©n√©ration PDF..." : idiomaAtual === 'en' ? "‚úÖ Valid code! Generating PDF..." : "‚úÖ C√≥digo v√°lido! Gerando PDF...";
                    
                    setTimeout(() => {
                        document.getElementById("progressContainer").style.display = "none";
                        gerarPDF();
                        msg.innerHTML = idiomaAtual === 'fr' ? "‚úÖ PDF g√©n√©r√©!" : idiomaAtual === 'en' ? "‚úÖ PDF generated!" : "‚úÖ PDF gerado!";
                        loading.style.display = "none";
                        
                        setTimeout(() => {
                            cancelarCodigo();
                            window.location.reload();
                        }, 1500);
                    }, 1000);
                } else {
                    msg.innerHTML = idiomaAtual === 'fr' ? "‚ùå Code invalide!" : idiomaAtual === 'en' ? "‚ùå Invalid code!" : "‚ùå C√≥digo inv√°lido!";
                    loading.style.display = "none";
                    document.getElementById("progressContainer").style.display = "none";
                }
            }, 2000);
        }

        async function gerarPDF() {
            const provincia = document.querySelector('.info-item:nth-child(1)')?.innerText.replace(/^[^:]*:/, '').trim() || '';
            const distrito = document.querySelector('.info-item:nth-child(2)')?.innerText.replace(/^[^:]*:/, '').trim() || '';
            const nomeEscola = document.querySelector('.info-item:nth-child(3)')?.innerText.replace(/^[^:]*:/, '').trim() || '';
            const classe = document.querySelector('.info-item:nth-child(4)')?.innerText.replace(/^[^:]*:/, '').trim() || '';
            const disciplina = document.querySelector('.info-item:nth-child(5)')?.innerText.replace(/^[^:]*:/, '').trim() || '';
            const trimestre = document.querySelector('.info-item:nth-child(6)')?.innerText.replace(/^[^:]*:/, '').trim() || '';
            
            const semanaInicio = document.getElementById('semanaInicio').value;
            const semanaFim = document.getElementById('semanaFim').value;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            
            pdf.setFont('Times', 'Roman');
            
            try {
                const imgUrl = 'https://raw.githubusercontent.com/nhanomb3/planodeaula/6143d599ba10a0f35fdf07a14baca1b76518bed3/1770417519977.png';
                const img = await fetch(imgUrl).then(res => res.blob()).then(blob => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                }));
                const pageWidth = pdf.internal.pageSize.getWidth();
                pdf.addImage(img, 'PNG', (pageWidth - 25) / 2, 3, 25, 18);
            } catch (e) { console.log('Erro ao carregar imagem:', e); }
            
            pdf.setFontSize(14);
            pdf.setFont('Times', 'bold');
            pdf.text('REP√öBLICA DE MO√áAMBIQUE', pdf.internal.pageSize.getWidth() / 2, 32, { align: 'center' });
            pdf.text(`PROV√çNCIA DE ${provincia.toUpperCase()}`, pdf.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            pdf.text(`GOVERNO DO DISTRITO DE ${distrito.toUpperCase()}`, pdf.internal.pageSize.getWidth() / 2, 48, { align: 'center' });
            pdf.text(nomeEscola.toUpperCase(), pdf.internal.pageSize.getWidth() / 2, 58, { align: 'center' });
            
            let tituloPlano = `PLANO QUINZENAL - ${disciplina}`;
            if (idiomaAtual === 'fr') tituloPlano = `PLAN QUINZENAL - ${disciplina}`;
            else if (idiomaAtual === 'en') tituloPlano = `FORTNIGHTLY PLAN - ${disciplina}`;
            pdf.text(tituloPlano, pdf.internal.pageSize.getWidth() / 2, 68, { align: 'center' });
            
            pdf.setFont('Times', 'normal');
            pdf.text(`${classe} - ${trimestre} 2026`, pdf.internal.pageSize.getWidth() / 2, 76, { align: 'center' });
            
            const periodoInicio = obterPeriodo(semanaInicio);
            const periodoFim = obterPeriodo(semanaFim);
            pdf.setFont('Times', 'bold');
            pdf.setFontSize(12);
            
            let periodoTexto = `PER√çODO: ${periodoInicio} √† ${periodoFim}`;
            if (idiomaAtual === 'fr') periodoTexto = `P√âRIODE: ${periodoInicio} √† ${periodoFim}`;
            else if (idiomaAtual === 'en') periodoTexto = `PERIOD: ${periodoInicio} to ${periodoFim}`;
            pdf.text(periodoTexto, 10, 86);
            
            let tituloSemana, tituloUnidade, tituloObjetivos, tituloConteudos, tituloTemas, tituloCH;
            if (idiomaAtual === 'fr') {
                tituloSemana = 'Semaine'; tituloUnidade = 'Unit√© Th√©matique'; tituloObjetivos = 'Objectifs Sp√©cifiques';
                tituloConteudos = 'Contenus'; tituloTemas = 'Th√®mes Trans.'; tituloCH = 'C.H.';
            } else if (idiomaAtual === 'en') {
                tituloSemana = 'Week'; tituloUnidade = 'Thematic Unit'; tituloObjetivos = 'Specific Objectives';
                tituloConteudos = 'Contents'; tituloTemas = 'Cross-cutting'; tituloCH = 'C.H.';
            } else {
                tituloSemana = 'Semana'; tituloUnidade = 'Unid. Tem√°tica'; tituloObjetivos = 'Objectivos Espec√≠ficos';
                tituloConteudos = 'Conte√∫dos'; tituloTemas = 'Temas Trans.'; tituloCH = 'C.H.';
            }
            
            const headers = [[tituloSemana, tituloUnidade, tituloObjetivos, tituloConteudos, tituloTemas, tituloCH]];
            const body = planosAtuais.map(plano => [
                plano.semana || '-',
                plano.unidadeTematica || '-',
                formatarComMarcadores(plano.objetivos),
                formatarComMarcadores(plano.conteudo),
                formatarComMarcadores(plano.temasTransversais),
                plano.cargaHoraria || '-'
            ]);
            
            pdf.autoTable({
                head: headers,
                body: body,
                startY: 94,
                theme: 'grid',
                styles: { font: 'Times', fontSize: 12, cellPadding: 3, lineColor: [0,0,0], textColor: [0,0,0], overflow: 'linebreak' },
                headStyles: { fillColor: [0,0,0], textColor: [255,255,255], fontStyle: 'bold', halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 18, halign: 'center', fontStyle: 'bold' },
                    1: { cellWidth: 30, halign: 'left' },
                    2: { cellWidth: 85, halign: 'left', valign: 'top' },
                    3: { cellWidth: 100, halign: 'left', valign: 'top' },
                    4: { cellWidth: 30, halign: 'left', valign: 'top' },
                    5: { cellWidth: 20, halign: 'center' }
                },
                margin: { left: 5, right: 5 },
                showHead: 'firstPage'
            });
            
            pdf.save(`Plano_Quinzenal_${classe}_${disciplina}.pdf`);
        }
    </script>
</body>
</html>