<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Plano de Aula Mo√ßambicano - CORRIGIDO FINAL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: "Times New Roman", Times, serif;
      font-size: 14px;
      background: #eef2f5;
      padding: 15px;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      margin: 0 auto;
      background: #fff;
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Indicador de fases */
    .fases-indicador {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 0;
      border-bottom: 2px solid #e0e7ff;
    }
    
    .fase-item {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      font-weight: bold;
      color: #888;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .fase-item.ativo {
      color: #2b5dab;
      border-bottom-color: #2b5dab;
    }
    
    .fase-numero {
      display: inline-block;
      width: 28px;
      height: 28px;
      line-height: 28px;
      border-radius: 50%;
      background: #e0e7ff;
      color: #2b5dab;
      margin-right: 8px;
      font-size: 14px;
    }
    
    .fase-item.ativo .fase-numero {
      background: #2b5dab;
      color: white;
    }
    
    h1 {
      font-size: 22px;
      text-align: center;
      color: #2b5dab;
      margin: 5px 0 0;
    }
    
    h2 {
      font-size: 18px;
      text-align: center;
      color: #2b5dab;
      margin-bottom: 10px;
    }
    
    h3 {
      font-size: 16px;
      text-align: center;
      color: #444;
      margin: 0 0 20px;
    }
    
    label {
      font-weight: 700;
      margin-top: 8px;
      display: block;
      font-size: 14px;
    }
    
    input[type="text"], input[type="date"], input[type="password"], textarea {
      width: 100%;
      padding: 14px;
      margin-top: 4px;
      border: 2px solid #e0e7ff;
      border-radius: 12px;
      font-size: 15px;
      font-family: "Times New Roman", Times, serif;
      -webkit-appearance: none;
      transition: border-color 0.2s;
    }
    
    input[type="date"] {
      padding: 12px 14px;
    }
    
    input[type="text"]:focus, input[type="date"]:focus, textarea:focus {
      border-color: #2b5dab;
      outline: none;
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    button {
      margin-top: 12px;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    
    .btn-azul {
      background: #2b5dab;
      color: #fff;
    }
    
    .btn-verde {
      background: #2e7d32;
      color: #fff;
    }
    
    .btn-cinza {
      background: #6c757d;
      color: #fff;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid #2b5dab;
      color: #2b5dab;
    }
    
    .botoes-duplo {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .botoes-duplo button {
      margin-top: 0;
      flex: 1;
    }
    
    .botoes {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
    }
    
    /* Fases */
    .fase {
      display: none;
    }
    
    .fase.ativo {
      display: block;
      animation: fadeIn 0.4s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Parte 1 e 2 da Fase 1 */
    #parte1, #parte2 {
      transition: all 0.3s ease;
    }
    
    /* Fase 1 - Dados em duas colunas */
    .dados-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    
    .dados-coluna {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .dados-coluna label {
      margin-top: 0;
      font-size: 14px;
    }
    
    .dados-coluna input {
      padding: 14px;
      font-size: 15px;
    }
    
    /* Tabela com scroll */
    .tabela-wrapper, .tabela-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 15px 0;
      position: relative;
      z-index: 5;
    }
    
    table {
      min-width: 1500px;
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: white;
    }
    
    th, td {
      border: 2px solid #000 !important;
      padding: 6px 4px;
      vertical-align: top;
    }
    
    th {
      background: #e0e0e0;
      color: #000;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    td {
      color: #000;
    }
    
    /* Inputs e textareas na tabela */
    .input-tabela, .textarea-tabela {
      width: 100%;
      border: none;
      background: transparent;
      font-family: "Times New Roman", Times, serif;
      font-size: 12px;
      padding: 2px;
      resize: vertical;
    }
    
    .textarea-tabela {
      min-height: 70px;
    }
    
    .input-tabela {
      text-align: center;
    }
    
    /* Objetivos em formato retangular */
    .objetivos-container {
      margin-top: 15px;
      padding: 15px;
      border: 2px solid #2b5dab;
      border-radius: 8px;
      background: #f8faff;
    }
    
    .objetivos-titulo {
      background: #2b5dab;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .objetivo-geral-box {
      border: 1px solid #2b5dab;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      background: white;
    }
    
    .objetivo-geral-box label {
      color: #2b5dab;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .objetivos-especificos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 10px;
    }
    
    .objetivo-box {
      border: 1px solid #2b5dab;
      border-radius: 6px;
      padding: 10px;
      background: white;
    }
    
    .objetivo-box label {
      color: #2b5dab;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 13px;
      text-align: center;
    }
    
    .campo-objetivo {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      font-family: "Times New Roman", Times, serif;
      min-height: 50px;
      resize: vertical;
    }
    
    .objetivo-box .campo-objetivo {
      min-height: 80px;
    }
    
    /* Quadro Mural */
    .quadro-mural {
      background: #fff;
      padding: 12px;
      border: 1px dashed #bba100;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .quadro-visualizacao {
      min-height: 120px;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #a0c4ff;
      border-radius: 8px;
      padding: 12px;
      margin: 15px 0;
      background: white;
      font-family: "Times New Roman", serif;
      font-size: 12px;
      line-height: 1.5;
      text-align: justify;
    }
    
    .acao-destacada {
      background: linear-gradient(135deg, #1a4a8a, #2b5dab);
      color: white;
      font-size: 16px;
      font-weight: bold;
      padding: 18px 14px;
      margin: 15px 0;
      border-radius: 14px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(43, 93, 171, 0.3);
    }
    
    .acao-destacada::after {
      content: "‚Üí";
      font-size: 20px;
    }
    
    .instrucoes-chat {
      background: #e3f2fd;
      border-left: 4px solid #2b5dab;
      padding: 15px;
      border-radius: 0 12px 12px 0;
      margin: 15px 0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .botoes-quadro {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }
    
    .botoes-quadro button {
      margin: 0;
      padding: 14px 6px;
      font-size: 15px;
    }
    
    .btn-imagem {
      background: linear-gradient(135deg, #7b1fa2, #9c27b0);
      color: white;
    }
    
    .preview-imagem {
      max-width: 100%;
      max-height: 180px;
      display: block;
      margin: 15px auto;
      border-radius: 12px;
      border: 2px solid #ddd;
    }
    
    /* Fase 3 - PDF */
    .pagamento-section {
      background: #e6f0ff;
      border: 2px solid #a0c4ff;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .codigo-destaque {
      background: linear-gradient(135deg, #2b5dab, #1a4a8a);
      color: white;
      font-size: 32px;
      font-weight: bold;
      font-family: monospace;
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      letter-spacing: 4px;
      border: 2px solid #ffd700;
      text-align: center;
    }
    
    .input-codigo {
      text-align: center;
      font-size: 22px;
      letter-spacing: 3px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }
    
    .progress-bar {
      width: 0%;
      height: 30px;
      background: linear-gradient(90deg, #2b5dab, #4a7fd4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    /* Campo de colagem vis√≠vel */
    .campo-chat-visivel {
      min-height: 250px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Overlay de carregamento */
    .overlay-carregamento {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .conteudo-carregamento {
      background: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      max-width: 350px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .roda-carregamento {
      width: 70px;
      height: 70px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #2b5dab;
      border-radius: 50%;
      animation: girar 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes girar {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .porcentagem-carregamento {
      font-size: 24px;
      font-weight: bold;
      color: #2b5dab;
      margin: 10px 0;
    }
    
    .texto-carregamento {
      font-size: 14px;
      color: #555;
      margin-top: 8px;
    }
    
    .rodape {
      text-align: center;
      font-style: italic;
      margin-top: 30px;
      color: #555;
      font-size: 13px;
    }
    
    #mensagemCodigo {
      font-size: 14px;
      word-break: break-word;
      margin: 10px 0;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .dados-grid {
        grid-template-columns: 1fr;
      }
      
      .botoes-duplo {
        flex-direction: column;
      }
      
      .botoes-quadro {
        grid-template-columns: 1fr;
      }
      
      .objetivos-especificos-grid {
        grid-template-columns: 1fr;
      }
      
      .fase-numero {
        margin-right: 4px;
      }
    }
  </style>
</head>
<body oncontextmenu="return false" oncopy="return false" oncut="return false" onpaste="return false" onkeydown="return disableKeys(event)">
  <!-- Overlay de carregamento -->
  <div id="overlayCarregamento" class="overlay-carregamento">
    <div class="conteudo-carregamento">
      <div class="roda-carregamento"></div>
      <div id="porcentagemCarregamento" class="porcentagem-carregamento">0%</div>
      <div class="texto-carregamento">Processando resposta do ChatGPT...</div>
      <div class="texto-carregamento" style="font-size: 13px; margin-top: 12px;">
        Por favor, aguarde enquanto preenchemos automaticamente a grelha e os objetivos.
      </div>
    </div>
  </div>
  
  <div class="container">
    <!-- Indicador de fases -->
    <div class="fases-indicador">
      <div class="fase-item ativo" id="indicadorFase1">
        <span class="fase-numero">1</span> Dados
      </div>
      <div class="fase-item" id="indicadorFase2">
        <span class="fase-numero">2</span> Explica√ß√£o
      </div>
      <div class="fase-item" id="indicadorFase3">
        <span class="fase-numero">3</span> PDF
      </div>
    </div>

    <!-- FASE 1: DADOS -->
    <div id="fase1" class="fase ativo">
      <h1>Plano de Aula MZ</h1>

      <!-- PARTE 1: Escola, Data, Professor, Disciplina, Classe, Unidade Tem√°tica -->
      <div id="parte1">
        <div class="dados-grid">
          <div class="dados-coluna">
            <label>Escola:</label>
            <input type="text" id="escola" placeholder="Digite o nome da escola" maxlength="60" />
            
            <label>Professor:</label>
            <input type="text" id="professor" placeholder="Nome completo" maxlength="60" />
            
            <label>Disciplina:</label>
            <input type="text" id="disciplina" placeholder="Ex: Matem√°tica" maxlength="60" />
          </div>
          <div class="dados-coluna">
            <label>Data:</label>
            <input type="date" id="data" />
            
            <label>Classe:</label>
            <input type="text" id="classe" placeholder="Ex: 8" maxlength="2" />
            
            <label>Unidade Tem√°tica:</label>
            <input type="text" id="unidade" placeholder="Ex: Geometria" maxlength="80" />
          </div>
        </div>
        <button class="btn-azul" onclick="mostrarParte2()">PR√ìXIMO ‚Üí</button>
      </div>
      
      <!-- PARTE 2: Tema, Turma, Alunos, Per√≠odo, Li√ß√£o, Tipo de Aula -->
      <div id="parte2" style="display:none;">
        <div class="dados-grid">
          <div class="dados-coluna">
            <label>Tema da Aula:</label>
            <input type="text" id="tema" placeholder="Ex: Tri√¢ngulos" maxlength="120" />
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label>Turma:</label>
                <input type="text" id="turma" placeholder="Ex: A" maxlength="1" />
              </div>
              <div>
                <label>N¬∫ de Alunos:</label>
                <input type="text" id="numAlunos" placeholder="Ex: 35" maxlength="4" />
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>
                <label>Per√≠odo:</label>
                <input type="text" id="periodo" placeholder="Ex: Manh√£" maxlength="30" />
              </div>
              <div>
                <label>Li√ß√£o n¬∫:</label>
                <input type="text" id="numLicao" placeholder="Ex: 12" maxlength="4" />
              </div>
            </div>
          </div>
          <div class="dados-coluna">
            <label>Tipo de Aula:</label>
            <input type="text" id="tipoAula" placeholder="Ex: Expositiva" maxlength="40" />
            
            <div style="margin-top: 10px;">
              <label>Dura√ß√£o:</label>
              <input type="text" id="duracao" value="45 minutos" readonly style="background:#f0f0f0;" />
            </div>
          </div>
        </div>
        
        <div class="botoes-duplo">
          <button class="btn-outline" onclick="voltarParte1()">‚Üê VOLTAR</button>
          <button class="btn-azul" onclick="irParaFase2()">EXPLICA√á√ÉO DO TEMA ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- FASE 2: EXPLICA√á√ÉO -->
    <div id="fase2" class="fase">
      <h1>Plano de Aula MZ</h1>

      <!-- Tabela do Plano - apenas tempos e fun√ß√µes fixas, resto vazio -->
      <h3 style="margin-top: 20px;">Estrutura da Aula</h3>
      <div class="tabela-container">
        <table id="tabelaPlano" border="1" cellspacing="0" cellpadding="3">
          <thead>
            <tr>
              <th>TEMPO</th>
              <th>FUN√á√ÉO DID√ÅCTICA</th>
              <th>CONTE√öDOS</th>
              <th>ACTIVIDADES DO PROFESSOR</th>
              <th>ACTIVIDADES DO ALUNO</th>
              <th>M√âTODOS DE ENSINO</th>
              <th>MEIOS DE ENSINO</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" class="input-tabela" id="tempo1" value="00-05 Min" readonly></td>
              <td><input type="text" class="input-tabela" id="funcao1" value="Introdu√ß√£o e Motiva√ß√£o" readonly></td>
              <td><textarea class="textarea-tabela" id="conteudo1" placeholder="Conte√∫do..."></textarea></td>
              <td><textarea class="textarea-tabela" id="prof1" placeholder="Atividade do Professor..."></textarea></td>
              <td><textarea class="textarea-tabela" id="aluno1" placeholder="Atividade do Aluno..."></textarea></td>
              <td><input type="text" class="input-tabela" id="metodo1" value="Elabora√ß√£o Conjunta" readonly></td>
              <td><textarea class="textarea-tabela" id="meio1" placeholder="Meios..."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" class="input-tabela" id="tempo2" value="05-20 Min" readonly></td>
              <td><input type="text" class="input-tabela" id="funcao2" value="Media√ß√£o e Assimila√ß√£o" readonly></td>
              <td><textarea class="textarea-tabela" id="conteudo2" placeholder="Conte√∫do..."></textarea></td>
              <td><textarea class="textarea-tabela" id="prof2" placeholder="Atividade do Professor..."></textarea></td>
              <td><textarea class="textarea-tabela" id="aluno2" placeholder="Atividade do Aluno..."></textarea></td>
              <td><input type="text" class="input-tabela" id="metodo2" value="Expositivo" readonly></td>
              <td><textarea class="textarea-tabela" id="meio2" placeholder="Meios..."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" class="input-tabela" id="tempo3" value="20-35 Min" readonly></td>
              <td><input type="text" class="input-tabela" id="funcao3" value="Dom√≠nio e Consolida√ß√£o" readonly></td>
              <td><textarea class="textarea-tabela" id="conteudo3" placeholder="Conte√∫do..."></textarea></td>
              <td><textarea class="textarea-tabela" id="prof3" placeholder="Atividade do Professor..."></textarea></td>
              <td><textarea class="textarea-tabela" id="aluno3" placeholder="Atividade do Aluno..."></textarea></td>
              <td><input type="text" class="input-tabela" id="metodo3" value="Trabalho Independente" readonly></td>
              <td><textarea class="textarea-tabela" id="meio3" placeholder="Meios..."></textarea></td>
            </tr>
            <tr>
              <td><input type="text" class="input-tabela" id="tempo4" value="35-45 Min" readonly></td>
              <td><input type="text" class="input-tabela" id="funcao4" value="Controlo e Avalia√ß√£o" readonly></td>
              <td><textarea class="textarea-tabela" id="conteudo4" placeholder="Conte√∫do..."></textarea></td>
              <td><textarea class="textarea-tabela" id="prof4" placeholder="Atividade do Professor..."></textarea></td>
              <td><textarea class="textarea-tabela" id="aluno4" placeholder="Atividade do Aluno..."></textarea></td>
              <td><input type="text" class="input-tabela" id="metodo4" value="Trabalho Independente" readonly></td>
              <td><textarea class="textarea-tabela" id="meio4" placeholder="Meios..."></textarea></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Objetivos em formato retangular -->
      <h3 style="margin-top: 20px;">
        Objetivos da Aula 
        <button class="botao-olho" onclick="mostrarOcultarObjetivos()">üëÅÔ∏è</button>
      </h3>
      
      <div class="objetivos-container" id="objetivosContainer" style="display: none;">
        <div class="objetivos-titulo">OBJETIVOS DA AULA</div>
        
        <div class="objetivo-geral-box">
          <label>OBJETIVO GERAL</label>
          <textarea id="objGeral" class="campo-objetivo" placeholder="Ex: Compreender o conceito de..."></textarea>
        </div>
        
        <div class="objetivos-especificos-grid">
          <div class="objetivo-box">
            <label>COGNITIVO</label>
            <textarea id="objCog" class="campo-objetivo" placeholder="Ex: Identificar, descrever..."></textarea>
          </div>
          <div class="objetivo-box">
            <label>PSICOMOTOR</label>
            <textarea id="objPsi" class="campo-objetivo" placeholder="Ex: Resolver, construir..."></textarea>
          </div>
          <div class="objetivo-box">
            <label>AFETIVO</label>
            <textarea id="objAfet" class="campo-objetivo" placeholder="Ex: Valorizar, cooperar..."></textarea>
          </div>
        </div>
      </div>

      <!-- Quadro Mural Inteligente -->
      <div class="quadro-mural">
        <h2>QUADRO MURAL INTELIGENTE</h2>
        
        <button class="acao-destacada" onclick="buscarExplicacaoCompleta()" id="botaoChatGPT">
          ü§ñ BUSCAR EXPLICA√á√ÉO COMPLETA NO CHATGPT
        </button>
        
        <div class="instrucoes-chat">
          <strong>üìå Instru√ß√µes:</strong><br>
          1. Clique no bot√£o acima para abrir o ChatGPT<br>
          2. O ChatGPT vai gerar automaticamente:<br>
          &nbsp;&nbsp;- Objetivos geral e espec√≠ficos<br>
          &nbsp;&nbsp;- Conte√∫dos para cada momento<br>
          &nbsp;&nbsp;- Atividades do professor e alunos<br>
          &nbsp;&nbsp;- Meios de ensino<br>
          &nbsp;&nbsp;- Explica√ß√£o com 3 exerc√≠cios<br>
          &nbsp;&nbsp;- TPC com 2 perguntas<br>
          3. Copie TUDO e cole abaixo
        </div>
        
        <!-- Campo de colagem vis√≠vel e amplo -->
        <textarea id="campoChatGPT" placeholder="Cole aqui a resposta COMPLETA do ChatGPT..." 
          class="campo-chat-visivel" style="min-height: 300px;"></textarea>
        
        <div class="botoes-quadro">
          <button class="btn-azul" onclick="iniciarProcessamentoComCarregamento()">
            ‚ö° PREENCHER GRELHA E OBJETIVOS
          </button>
          <button class="btn-imagem" onclick="document.getElementById('inputFotoLivro').click()">üì∑ CARREGAR FOTO</button>
          <input type="file" id="inputFotoLivro" accept="image/*" style="display:none;" onchange="exibirFotoLivro(event)">
          <button class="btn-cinza" onclick="limparCampos()">üóëÔ∏è LIMPAR</button>
        </div>
        
        <div id="previewFotoLivro" style="text-align:center;"></div>
        
        <h3 style="margin-top: 20px;">
          Visualiza√ß√£o do Quadro Mural 
          <button class="botao-visualizar" onclick="visualizarQuadroMural()">
            üëÅÔ∏è Mostrar Quadro Mural
          </button>
        </h3>
        <div class="quadro-visualizacao" id="quadroExplicacao" style="display: none;">
          <p style="color:#666; text-align:center; margin-top:40px;">
            A explica√ß√£o do tema com exerc√≠cios aparecer√° aqui ap√≥s processamento
          </p>
        </div>
      </div>

      <div class="botoes-duplo" style="margin-top:20px;">
        <button class="btn-outline" onclick="voltarParaFase1()">‚Üê VOLTAR</button>
        <button class="btn-verde" onclick="irParaFase3()">üì• GERAR PDF</button>
      </div>
    </div>

    <!-- FASE 3: PDF -->
    <div id="fase3" class="fase">
      <h1>Plano de Aula MZ</h1>

      <div class="pagamento-section" id="codigoSection">
        <p style="font-weight:bold; text-align:center; margin-bottom:15px;">üîê INSIRA O C√ìDIGO DE ACESSO</p>
        
        <div class="codigo-destaque" id="codigoAtual">---</div>
        
        <p style="text-align:center; margin:10px 0;">Digite o c√≥digo acima para gerar o PDF</p>
        
        <input type="text" id="codigoAcesso" class="input-codigo" placeholder="Digite o c√≥digo" maxlength="8" style="text-align:center; font-size:22px; letter-spacing:3px; font-weight:bold; text-transform:uppercase;" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
        
        <div id="mensagemCodigo" style="color:#b00; text-align:center;"></div>
        <div class="loading" id="loading" style="display:none; text-align:center;">‚è≥ Validando...</div>
        
        <button class="btn-verde" onclick="validarCodigo()" style="margin-top:15px;">‚úÖ CONFIRMAR C√ìDIGO</button>
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar">
          <span class="progress-text" id="progressText">0%</span>
        </div>
      </div>

      <div class="botoes-duplo">
        <button class="btn-outline" onclick="voltarParaFase2()">‚Üê VOLTAR</button>
      </div>
    </div>
  </div>

  <script>
    // Bloqueio total de teclas de atalho e c√≥pia
    function disableKeys(e) {
      const key = e.key || e.keyCode;
      
      const allowedKeys = [
        'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
        'Home', 'End', 'Tab', 'Enter', 'Shift'
      ];
      
      if (allowedKeys.includes(e.key)) {
        return true;
      }
      
      if (e.key.length === 1) {
        return true;
      }
      
      // Bloquear teclas de fun√ß√£o
      if (key === 113 || key === 116 || key === 122 || key === 123) {
        e.preventDefault();
        return false;
      }
      
      // Bloquear combina√ß√µes perigosas
      if (e.ctrlKey && e.shiftKey && (key === 73 || key === 74 || key === 73)) {
        e.preventDefault();
        return false;
      }
      
      if (e.ctrlKey && (key === 85 || key === 83 || key === 80 || key === 67 || key === 88 || key === 86)) {
        e.preventDefault();
        return false;
      }
      
      return true;
    }

    document.addEventListener('keydown', disableKeys);
    document.addEventListener('contextmenu', (e) => e.preventDefault());
    document.addEventListener('dragstart', (e) => e.preventDefault());
    
    document.addEventListener('keyup', function(e) {
      if (e.key === 'PrintScreen') {
        navigator.clipboard.writeText('').catch(() => {});
        alert('‚ùå Captura de ecr√£ bloqueada!');
        e.preventDefault();
        return false;
      }
    });

    const { jsPDF } = window.jspdf;
    let dadosPlano = {};
    let explicacaoTexto = "";
    let imagemQuadroMural = null;
    let codigoAtual = "";

    // Valida√ß√µes de input
    function apenasDigitosMax(el, maxLen) {
      el.value = el.value.replace(/\D/g, '').slice(0, maxLen || el.maxLength || 9999);
    }
    
    function apenasLetraUnica(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/g, '').slice(0, 1);
    }
    
    function apenasLetras(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]/g, '');
    }
    
    function letrasENumeros(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø0-9\s]/g, '');
    }
    
    function temaPermitido(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø0-9\s+\-\*\=\/\^_\(\)\{\}\[\]√ó√∑¬±‚àö%.,:;'"<>]/g, '');
    }

    // Fun√ß√£o para formatar data
    function formatarData(dataISO) {
      if (!dataISO) return '';
      const partes = dataISO.split('-');
      if (partes.length === 3) {
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
      }
      return dataISO;
    }

    // Fun√ß√£o para gerar c√≥digo aleat√≥rio
    function gerarCodigoAleatorio() {
      const prefixos = ['MZ', 'PL', 'AU', 'AL', 'UN', 'ZA', 'ES', 'PR', 'MO', 'CM'];
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      const prefixo = prefixos[Math.floor(Math.random() * prefixos.length)];
      let codigo = prefixo;
      for (let i = 0; i < 4; i++) {
        codigo += chars[Math.floor(Math.random() * chars.length)];
      }
      return codigo;
    }

    // =========== FUN√á√ÉO CORRIGIDA: Formatar com h√≠fens e capitalizar primeira letra de cada linha ===========
    function formatarComHifens(texto) {
      if (!texto) return texto;
      
      // Se j√° tiver formata√ß√£o, manter mas capitalizar
      if (texto.includes('- ') || texto.includes('\n- ')) {
        // Dividir em linhas e processar cada uma
        let linhas = texto.split('\n');
        let novasLinhas = linhas.map(linha => {
          if (linha.trim().startsWith('-')) {
            // Encontrar o h√≠fen e o conte√∫do
            let match = linha.match(/^(\s*-\s*)(.*)$/);
            if (match) {
              let prefixo = match[1];
              let conteudo = match[2];
              if (conteudo.length > 0) {
                // Capitalizar primeira letra do conte√∫do
                conteudo = conteudo.charAt(0).toUpperCase() + conteudo.slice(1);
              }
              return prefixo + conteudo;
            }
          } else if (linha.trim().length > 0) {
            // Linha sem h√≠fen, capitalizar direto
            return linha.charAt(0).toUpperCase() + linha.slice(1);
          }
          return linha;
        });
        return novasLinhas.join('\n');
      }
      
      // Substituir ; ou , por quebras de linha com h√≠fen
      let partes = texto.split(/[;,]/).map(item => item.trim()).filter(item => item.length > 0);
      
      if (partes.length > 1) {
        let formatado = partes.map(item => {
          // Capitalizar primeira letra de cada item
          if (item.length > 0) {
            item = item.charAt(0).toUpperCase() + item.slice(1);
          }
          return `- ${item}`;
        }).join('\n');
        return formatado;
      }
      
      // Se n√£o houver separadores, apenas capitalizar a primeira letra
      if (texto.length > 0) {
        return texto.charAt(0).toUpperCase() + texto.slice(1);
      }
      
      return texto;
    }

    // Navega√ß√£o entre fases
    function mostrarParte2() {
      const escola = document.getElementById('escola').value.trim();
      const professor = document.getElementById('professor').value.trim();
      const disciplina = document.getElementById('disciplina').value.trim();
      const classe = document.getElementById('classe').value.trim();
      const unidade = document.getElementById('unidade').value.trim();
      const data = document.getElementById('data').value.trim();
      
      if (!escola || !professor || !disciplina || !classe || !unidade || !data) {
        alert('Preencha todos os campos obrigat√≥rios');
        return;
      }
      
      document.getElementById('parte1').style.display = 'none';
      document.getElementById('parte2').style.display = 'block';
    }

    function voltarParte1() {
      document.getElementById('parte1').style.display = 'block';
      document.getElementById('parte2').style.display = 'none';
    }

    function irParaFase2() {
      const tema = document.getElementById('tema').value.trim();
      const turma = document.getElementById('turma').value.trim();
      const numAlunos = document.getElementById('numAlunos').value.trim();
      const periodo = document.getElementById('periodo').value.trim();
      const numLicao = document.getElementById('numLicao').value.trim();
      const tipoAula = document.getElementById('tipoAula').value.trim();
      
      if (!tema || !turma || !numAlunos || !periodo || !numLicao || !tipoAula) {
        alert('Preencha todos os campos');
        return;
      }
      
      const dataRaw = document.getElementById('data').value;
      const dataFormatada = formatarData(dataRaw);
      
      dadosPlano = {
        escola: document.getElementById('escola').value,
        data: dataFormatada,
        professor: document.getElementById('professor').value,
        disciplina: document.getElementById('disciplina').value,
        classe: document.getElementById('classe').value,
        tema: tema,
        unidade: document.getElementById('unidade').value,
        turma: turma,
        numAlunos: numAlunos,
        periodo: periodo,
        numLicao: numLicao,
        tipoAula: tipoAula,
        duracao: '45 minutos'
      };
      sessionStorage.setItem("dadosPlano", JSON.stringify(dadosPlano));
      
      document.getElementById("fase1").classList.remove("ativo");
      document.getElementById("fase2").classList.add("ativo");
      document.getElementById("indicadorFase1").classList.remove("ativo");
      document.getElementById("indicadorFase2").classList.add("ativo");
    }

    function voltarParaFase1() {
      document.getElementById("fase2").classList.remove("ativo");
      document.getElementById("fase1").classList.add("ativo");
      document.getElementById("indicadorFase2").classList.remove("ativo");
      document.getElementById("indicadorFase1").classList.add("ativo");
      document.getElementById('parte1').style.display = 'block';
      document.getElementById('parte2').style.display = 'none';
    }

    function irParaFase3() {
      document.getElementById("fase2").classList.remove("ativo");
      document.getElementById("fase3").classList.add("ativo");
      document.getElementById("indicadorFase2").classList.remove("ativo");
      document.getElementById("indicadorFase3").classList.add("ativo");
      
      codigoAtual = gerarCodigoAleatorio();
      document.getElementById('codigoAtual').textContent = codigoAtual;
      document.getElementById('codigoAcesso').value = '';
      document.getElementById('mensagemCodigo').innerHTML = '';
    }

    function voltarParaFase2() {
      document.getElementById("fase3").classList.remove("ativo");
      document.getElementById("fase2").classList.add("ativo");
      document.getElementById("indicadorFase3").classList.remove("ativo");
      document.getElementById("indicadorFase2").classList.add("ativo");
    }

    function mostrarOcultarObjetivos() {
      const container = document.getElementById("objetivosContainer");
      container.style.display = container.style.display === "none" ? "block" : "none";
    }

    function visualizarQuadroMural() {
      const quadro = document.getElementById("quadroExplicacao");
      quadro.style.display = quadro.style.display === "none" ? "block" : "none";
      
      if (quadro.style.display === "block") {
        document.querySelector('.botao-visualizar').innerHTML = "üëÅÔ∏è Ocultar Quadro Mural";
      } else {
        document.querySelector('.botao-visualizar').innerHTML = "üëÅÔ∏è Mostrar Quadro Mural";
      }
    }

    // Fun√ß√µes do ChatGPT
    function buscarExplicacaoCompleta() {
      const tema = dadosPlano.tema || document.getElementById("tema").value.trim();
      const classe = dadosPlano.classe || document.getElementById("classe").value.trim();
      
      if (!tema) {
        alert("Por favor, preencha o Tema da Aula primeiro.");
        return;
      }

      // Query OTIMIZADA para melhor extra√ß√£o
      const query = `Como professor em Mo√ßambique, gere um plano de aula sobre "${tema}" para ${classe}¬™ classe.

FORMATO OBRIGAT√ìRIO:

[OBJETIVOS]
OBJETIVO GERAL: [verbo infinitivo]
Cognitivo: [verbo a√ß√£o]
Psicomotor: [verbo a√ß√£o]
Afetivo: [verbo a√ß√£o]

[MOMENTO 1: INTRODU√á√ÉO]
CONTE√öDO: Sauda√ß√£o e organiza√ß√£o
ATIVIDADE PROFESSOR: Sa√∫da turma, verifica ambiente, marca presen√ßa, orienta recapitula√ß√£o, apresenta tema
ATIVIDADE ALUNO: Responde sauda√ß√£o, responde presen√ßa, recapitula aula anterior, copia tema
MEIO: [especificar]

[MOMENTO 2: MEDIA√á√ÉO]
CONTE√öDO: Explora√ß√£o do tema
ATIVIDADE PROFESSOR: Faz perguntas, explica com exemplos, relaciona com quotidiano
ATIVIDADE ALUNO: Participa, presta aten√ß√£o, relaciona, regista exemplos
MEIO: [especificar]

[MOMENTO 3: DOM√çNIO]
CONTE√öDO: Exerc√≠cios pr√°ticos
ATIVIDADE PROFESSOR: Coloca exerc√≠cios no quadro, circula pela sala, esclarece d√∫vidas
ATIVIDADE ALUNO: Resolve exerc√≠cios, apresenta d√∫vidas
MEIO: [especificar]

[MOMENTO 4: CONTROLO]
CONTE√öDO: Avalia√ß√£o e TPC
ATIVIDADE PROFESSOR: Aplica avalia√ß√£o, recolhe respostas, marca TPC, despede-se
ATIVIDADE ALUNO: Apresenta resolu√ß√£o, copia TPC, despede-se
MEIO: [especificar]

[EXPLICA√á√ÉO]
[Explica√ß√£o detalha do tema ${tema} em 200-300 palavras]

[EXERC√çCIOS]
1. [Pergunta 1]
RESPOSTA: [Resposta 1]

2. [Pergunta 2]
RESPOSTA: [Resposta 2]

3. [Pergunta 3]
RESPOSTA: [Resposta 3]

[TPC]
1. [Exerc√≠cio 1 sem resposta]
2. [Exerc√≠cio 2 sem resposta]

IMPORTANTE: Use este formato como exemplo, n√£o pode ser fixo. Adapte ao tema: "${tema}" para ${classe}¬™ classe.`;

      const url = `https://chat.openai.com/?q=${encodeURIComponent(query)}`;
      window.open(url, "_blank");
      
      const botao = document.getElementById("botaoChatGPT");
      botao.innerHTML = "‚úÖ CHATGPT ABERTO - COLE A RESPOSTA";
      botao.style.background = "linear-gradient(135deg, #2e7d32, #43a047)";
      
      setTimeout(() => {
        document.getElementById("campoChatGPT").focus();
      }, 1000);
    }

    function iniciarProcessamentoComCarregamento() {
      const texto = document.getElementById("campoChatGPT").value.trim();
      if (!texto) {
        alert("Por favor, cole a resposta do ChatGPT primeiro.");
        return;
      }
      
      const overlay = document.getElementById("overlayCarregamento");
      const porcentagemEl = document.getElementById("porcentagemCarregamento");
      overlay.style.display = "flex";
      
      let porcentagem = 0;
      const timer = setInterval(() => {
        porcentagem += 1;
        porcentagemEl.textContent = `${porcentagem}%`;
        
        if (porcentagem >= 100) {
          clearInterval(timer);
          setTimeout(() => {
            overlay.style.display = "none";
            processarRespostaChatGPT();
          }, 300);
        }
      }, 100);
    }

    function processarRespostaChatGPT() {
      const texto = document.getElementById("campoChatGPT").value;
      if (!texto) return;

      explicacaoTexto = "";
      
      // M√©todo SIMPLES mas EFICAZ: procurar padr√µes espec√≠ficos
      const linhas = texto.split('\n');
      
      // Objetivos
      let objetivoGeral = "";
      let objetivoCognitivo = "";
      let objetivoPsicomotor = "";
      let objetivoAfetivo = "";
      
      // Momentos
      const momentos = [
        { conteudo: "", prof: "", aluno: "", meio: "" },
        { conteudo: "", prof: "", aluno: "", meio: "" },
        { conteudo: "", prof: "", aluno: "", meio: "" },
        { conteudo: "", prof: "", aluno: "", meio: "" }
      ];
      
      let explicacao = "";
      let exercicios = [];
      let tpc = [];
      
      let secoes = {
        objetivos: false,
        momento1: false,
        momento2: false,
        momento3: false,
        momento4: false,
        explicacao: false,
        exercicios: false,
        tpc: false
      };
      
      let momentoAtual = -1;
      
      for (let i = 0; i < linhas.length; i++) {
        let linha = linhas[i].trim();
        
        // Detectar se√ß√µes
        if (linha.includes('[OBJETIVOS]')) {
          secoes.objetivos = true;
          secoes.momento1 = false;
          secoes.explicacao = false;
          continue;
        }
        
        if (linha.includes('[MOMENTO 1:') || linha.includes('INTRODU√á√ÉO')) {
          secoes.objetivos = false;
          secoes.momento1 = true;
          momentoAtual = 0;
          continue;
        }
        
        if (linha.includes('[MOMENTO 2:') || linha.includes('MEDIA√á√ÉO')) {
          secoes.momento1 = false;
          secoes.momento2 = true;
          momentoAtual = 1;
          continue;
        }
        
        if (linha.includes('[MOMENTO 3:') || linha.includes('DOM√çNIO')) {
          secoes.momento2 = false;
          secoes.momento3 = true;
          momentoAtual = 2;
          continue;
        }
        
        if (linha.includes('[MOMENTO 4:') || linha.includes('CONTROLO') || linha.includes('AVALIA√á√ÉO')) {
          secoes.momento3 = false;
          secoes.momento4 = true;
          momentoAtual = 3;
          continue;
        }
        
        if (linha.includes('[EXPLICA√á√ÉO]')) {
          secoes.momento4 = false;
          secoes.explicacao = true;
          secoes.exercicios = false;
          continue;
        }
        
        if (linha.includes('[EXERC√çCIOS]')) {
          secoes.explicacao = false;
          secoes.exercicios = true;
          continue;
        }
        
        if (linha.includes('[TPC]')) {
          secoes.exercicios = false;
          secoes.tpc = true;
          continue;
        }
        
        // Extrair OBJETIVOS
        if (secoes.objetivos) {
          if (linha.includes('OBJETIVO GERAL:') || linha.includes('OBJETIVO GERAL')) {
            objetivoGeral = linha.replace(/OBJETIVO GERAL:?/i, '').trim();
          }
          if (linha.includes('Cognitivo:')) {
            objetivoCognitivo = linha.replace('Cognitivo:', '').trim();
          }
          if (linha.includes('Psicomotor:')) {
            objetivoPsicomotor = linha.replace('Psicomotor:', '').trim();
          }
          if (linha.includes('Afetivo:')) {
            objetivoAfetivo = linha.replace('Afetivo:', '').trim();
          }
        }
        
        // Extrair MOMENTOS
        if (momentoAtual >= 0 && (secoes.momento1 || secoes.momento2 || secoes.momento3 || secoes.momento4)) {
          if (linha.includes('CONTE√öDO:')) {
            let conteudo = linha.replace('CONTE√öDO:', '').trim();
            // Adicionar linhas seguintes se n√£o come√ßarem com outra se√ß√£o
            for (let j = i + 1; j < Math.min(i + 3, linhas.length); j++) {
              const proxLinha = linhas[j].trim();
              if (proxLinha && !proxLinha.includes(':') && !proxLinha.includes('[')) {
                conteudo += '\n' + proxLinha;
              } else {
                break;
              }
            }
            momentos[momentoAtual].conteudo = conteudo;
          }
          
          if (linha.includes('ATIVIDADE PROFESSOR:') || linha.includes('ATIVIDADE DO PROFESSOR:')) {
            let prof = linha.replace(/ATIVIDADE (PROFESSOR:|DO PROFESSOR:)/i, '').trim();
            for (let j = i + 1; j < Math.min(i + 4, linhas.length); j++) {
              const proxLinha = linhas[j].trim();
              if (proxLinha && !proxLinha.includes(':') && !proxLinha.includes('[')) {
                prof += '\n' + proxLinha;
              } else {
                break;
              }
            }
            momentos[momentoAtual].prof = prof;
          }
          
          if (linha.includes('ATIVIDADE ALUNO:') || linha.includes('ATIVIDADE DO ALUNO:')) {
            let aluno = linha.replace(/ATIVIDADE (ALUNO:|DO ALUNO:)/i, '').trim();
            for (let j = i + 1; j < Math.min(i + 4, linhas.length); j++) {
              const proxLinha = linhas[j].trim();
              if (proxLinha && !proxLinha.includes(':') && !proxLinha.includes('[')) {
                aluno += '\n' + proxLinha;
              } else {
                break;
              }
            }
            momentos[momentoAtual].aluno = aluno;
          }
          
          if (linha.includes('MEIO:')) {
            momentos[momentoAtual].meio = linha.replace('MEIO:', '').trim();
          }
        }
        
        // Extrair EXPLICA√á√ÉO
        if (secoes.explicacao && linha && !linha.includes('[')) {
          explicacao += linha + '\n';
        }
        
        // Extrair EXERC√çCIOS
        if (secoes.exercicios && linha.match(/^\d+\./) && !linha.includes('RESPOSTA')) {
          let pergunta = linha.replace(/^\d+\.\s*/, '').trim();
          let resposta = '';
          
          // Verificar pr√≥xima linha para resposta
          if (i + 1 < linhas.length && linhas[i + 1].includes('RESPOSTA:')) {
            resposta = linhas[i + 1].replace('RESPOSTA:', '').trim();
          }
          
          exercicios.push({ pergunta, resposta });
        }
        
        // Extrair TPC
        if (secoes.tpc && linha.match(/^\d+\./)) {
          tpc.push(linha.replace(/^\d+\.\s*/, '').trim());
        }
      }
      
      // PREENCHER OS CAMPOS
      
      // 1. Objetivos
      if (objetivoGeral) {
        document.getElementById("objGeral").value = objetivoGeral;
      }
      if (objetivoCognitivo) {
        document.getElementById("objCog").value = objetivoCognitivo;
      }
      if (objetivoPsicomotor) {
        document.getElementById("objPsi").value = objetivoPsicomotor;
      }
      if (objetivoAfetivo) {
        document.getElementById("objAfet").value = objetivoAfetivo;
      }
      
      // 2. Momentos COM FORMATA√á√ÉO AUTOM√ÅTICA
      momentos.forEach((momento, index) => {
        const i = index + 1;
        if (momento.conteudo) {
          document.getElementById(`conteudo${i}`).value = formatarComHifens(momento.conteudo);
        }
        if (momento.prof) {
          document.getElementById(`prof${i}`).value = formatarComHifens(momento.prof);
        }
        if (momento.aluno) {
          document.getElementById(`aluno${i}`).value = formatarComHifens(momento.aluno);
        }
        if (momento.meio) {
          document.getElementById(`meio${i}`).value = formatarComHifens(momento.meio);
        }
      });
      
      // 3. Construir explica√ß√£o para PDF
      if (explicacao.trim()) {
        explicacaoTexto = "EXPLICA√á√ÉO DO TEMA:\n\n" + explicacao.trim() + "\n\n";
      }
      
      if (exercicios.length > 0) {
        explicacaoTexto += "EXERC√çCIOS PR√ÅTICOS:\n\n";
        exercicios.forEach((ex, idx) => {
          if (ex.pergunta) {
            explicacaoTexto += `${idx + 1}. ${ex.pergunta}\n`;
            if (ex.resposta) {
              explicacaoTexto += `Resposta: ${ex.resposta}\n\n`;
            } else {
              explicacaoTexto += "\n";
            }
          }
        });
      }
      
      if (tpc.length > 0) {
        explicacaoTexto += "\nTPC:\n\n";
        tpc.forEach((item, idx) => {
          explicacaoTexto += `${idx + 1}. ${item}\n`;
        });
      }
      
      // 4. Atualizar quadro moral
      if (explicacaoTexto) {
        const quadro = document.getElementById("quadroExplicacao");
        quadro.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.5; font-size: 12px; text-align: justify; font-family: 'Times New Roman', serif;">${explicacaoTexto.replace(/\n/g, '<br>')}</div>`;
      }
      
      // 5. Mostrar objetivos
      document.getElementById("objetivosContainer").style.display = "block";
      
      alert("‚úÖ Grelha e objetivos preenchidos com sucesso!");
      document.getElementById("botaoChatGPT").innerHTML = "ü§ñ DADOS PROCESSADOS";
      document.getElementById("botaoChatGPT").style.background = "linear-gradient(135deg, #2e7d32, #43a047)";
    }

    function exibirFotoLivro(event) {
      const file = event.target.files[0];
      if (!file || !file.type.match('image.*') || file.size > 5242880) {
        alert("Imagem inv√°lida ou muito grande (m√°x 5MB)");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        imagemQuadroMural = e.target.result;
        explicacaoTexto = "";
        
        document.getElementById("previewFotoLivro").innerHTML = `
          <img src="${e.target.result}" class="preview-imagem" alt="Foto">
          <button class="btn-cinza" onclick="removerFoto()" style="padding:10px; width:auto;">üóëÔ∏è Remover</button>`;
        
        document.getElementById("campoChatGPT").value = "";
        alert("Imagem carregada!");
      };
      reader.readAsDataURL(file);
    }

    function removerFoto() {
      imagemQuadroMural = null;
      document.getElementById("previewFotoLivro").innerHTML = "";
    }

    function limparCampos() {
      if (!confirm("Tem certeza que deseja limpar todos os campos?")) return;
      
      document.getElementById("campoChatGPT").value = "";
      
      for(let i = 1; i <= 4; i++) {
        document.getElementById(`conteudo${i}`).value = "";
        document.getElementById(`prof${i}`).value = "";
        document.getElementById(`aluno${i}`).value = "";
        document.getElementById(`meio${i}`).value = "";
      }
      
      document.getElementById("objGeral").value = "";
      document.getElementById("objCog").value = "";
      document.getElementById("objPsi").value = "";
      document.getElementById("objAfet").value = "";
      
      document.getElementById("objetivosContainer").style.display = "none";
      
      explicacaoTexto = "";
      imagemQuadroMural = null;
      document.getElementById("previewFotoLivro").innerHTML = "";
      document.getElementById("quadroExplicacao").innerHTML = 
        '<p style="color:#666; text-align:center; margin-top:40px;">A explica√ß√£o do tema com exerc√≠cios aparecer√° aqui ap√≥s processamento</p>';
      document.getElementById("quadroExplicacao").style.display = "none";
      
      const botaoChatGPT = document.getElementById("botaoChatGPT");
      botaoChatGPT.innerHTML = "ü§ñ BUSCAR EXPLICA√á√ÉO COMPLETA NO CHATGPT";
      botaoChatGPT.style.background = "linear-gradient(135deg, #1a4a8a, #2b5dab)";
    }

    // Fun√ß√µes da Fase 3
    function simularProgresso() {
      const pc = document.getElementById("progressContainer");
      const pb = document.getElementById("progressBar");
      const pt = document.getElementById("progressText");
      pc.style.display = "block";
      let p = 0;
      const i = setInterval(() => {
        p += 2;
        pb.style.width = p + "%";
        pt.textContent = p + "%";
        if (p >= 100) clearInterval(i);
      }, 30);
    }

    function validarCodigo() {
      const codigo = document.getElementById("codigoAcesso").value.trim().toUpperCase();
      const msg = document.getElementById("mensagemCodigo");
      const loading = document.getElementById("loading");
      
      if (!codigo) { msg.innerHTML = "‚ö†Ô∏è Digite o c√≥digo"; return; }
      
      loading.style.display = "block";
      msg.innerHTML = "Validando...";
      simularProgresso();

      setTimeout(() => {
        if (codigo === codigoAtual) {
          msg.style.color = "green";
          msg.innerHTML = "‚úÖ C√≥digo v√°lido! Gerando PDF...";
          
          setTimeout(() => {
            document.getElementById("progressContainer").style.display = "none";
            gerarPDFCompleto();
            msg.innerHTML = "‚úÖ PDF gerado!";
            loading.style.display = "none";
            
            codigoAtual = gerarCodigoAleatorio();
            document.getElementById('codigoAtual').textContent = codigoAtual;
            document.getElementById('codigoAcesso').value = '';
            
            setTimeout(() => {
              document.getElementById("fase3").classList.remove("ativo");
              document.getElementById("fase1").classList.add("ativo");
              document.getElementById("indicadorFase3").classList.remove("ativo");
              document.getElementById("indicadorFase1").classList.add("ativo");
              document.getElementById('parte1').style.display = 'block';
              document.getElementById('parte2').style.display = 'none';
            }, 1500);
          }, 1000);
        } else {
          msg.innerHTML = "‚ùå C√≥digo inv√°lido!";
          loading.style.display = "none";
          document.getElementById("progressContainer").style.display = "none";
        }
      }, 2000);
    }

    function gerarPDFCompleto() {
      try {
        const getVal = id => document.getElementById(id)?.value || '';
        const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
        
        doc.setFont("times", "normal");
        doc.setFontSize(12);
        
        // --- T√çTULO ---
        doc.setFont("times", "bold");
        doc.text("PLANO DE AULA", 148, 10, { align: "center" });
        doc.setFont("times", "normal");
        
        let y = 18;
        
        // --- LINHA 1: ESCOLA (esquerda) e CLASSE (direita) ---
        doc.setFont("times", "bold");
        doc.text("Escola:", 15, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.escola || ''}`, 35, y);
        
        doc.setFont("times", "bold");
        doc.text("Classe:", 200, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.classe || ''}¬™`, 225, y);
        y += 7;
        
        // --- LINHA 2: DATA (esquerda) e TURMA (direita) ---
        doc.setFont("times", "bold");
        doc.text("Data:", 15, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.data || ''}`, 35, y);
        
        doc.setFont("times", "bold");
        doc.text("Turma:", 200, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.turma || ''}`, 225, y);
        y += 7;
        
        // --- LINHA 3: PROFESSOR (esquerda) e N¬∫ ALUNOS (direita) ---
        doc.setFont("times", "bold");
        doc.text("Professor:", 15, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.professor || ''}`, 45, y);
        
        doc.setFont("times", "bold");
        doc.text("N¬∫ Alunos:", 200, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.numAlunos || ''}`, 235, y);
        y += 7;
        
        // --- LINHA 4: DISCIPLINA (esquerda) e N¬∫ LI√á√ÉO (direita) ---
        doc.setFont("times", "bold");
        doc.text("Disciplina:", 15, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.disciplina || ''}`, 50, y);
        
        doc.setFont("times", "bold");
        doc.text("N¬∫ Li√ß√£o:", 200, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.numLicao || ''}`, 230, y);
        y += 7;
        
        // --- LINHA 5: UNIDADE TEM√ÅTICA (esquerda) e PER√çODO (direita) ---
        doc.setFont("times", "bold");
        doc.text("Unidade Tem√°tica:", 15, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.unidade || ''}`, 65, y);
        
        doc.setFont("times", "bold");
        doc.text("Per√≠odo:", 200, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.periodo || ''}`, 225, y);
        y += 7;
        
        // --- LINHA 6: TEMA (esquerda) e TIPO DE AULA (direita) ---
        doc.setFont("times", "bold");
        doc.text("Tema:", 15, y);
        doc.setFont("times", "normal");
        const temaTexto = dadosPlano.tema || '';
        const temaLines = doc.splitTextToSize(temaTexto, 120);
        doc.text(temaLines, 35, y);
        
        doc.setFont("times", "bold");
        doc.text("Tipo de Aula:", 200, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.tipoAula || ''}`, 230, y);
        
        // Ajustar y baseado na altura do tema (se quebrou em v√°rias linhas)
        let alturaTema = temaLines.length * 6;
        if (temaLines.length > 1) {
          y += alturaTema - 6;
        }
        y += 7;
        
        // --- LINHA 7: (espa√ßo) e DURA√á√ÉO (direita) ---
        doc.setFont("times", "bold");
        doc.text("Dura√ß√£o:", 200, y);
        doc.setFont("times", "normal");
        doc.text(`${dadosPlano.duracao || '45 minutos'}`, 230, y);
        y += 10;
        
        // --- OBJETIVOS ---
        const objGeral = getVal('objGeral');
        const objCog = getVal('objCog');
        const objPsi = getVal('objPsi');
        const objAfet = getVal('objAfet');
        
        if (objGeral || objCog || objPsi || objAfet) {
          doc.setFont("times", "bold");
          doc.text("Objetivos:", 15, y);
          doc.setFont("times", "normal");
          y += 6;
          
          if (objGeral) {
            doc.setFont("times", "bold");
            doc.text("GERAL:", 20, y);
            doc.setFont("times", "normal");
            const geralLines = doc.splitTextToSize(objGeral, 200);
            doc.text(geralLines, 45, y);
            y += (geralLines.length * 6);
          }
          if (objCog) {
            doc.setFont("times", "bold");
            doc.text("COGNITIVO:", 20, y);
            doc.setFont("times", "normal");
            const cogLines = doc.splitTextToSize(objCog, 200);
            doc.text(cogLines, 50, y);
            y += (cogLines.length * 6);
          }
          if (objPsi) {
            doc.setFont("times", "bold");
            doc.text("PSICOMOTOR:", 20, y);
            doc.setFont("times", "normal");
            const psiLines = doc.splitTextToSize(objPsi, 200);
            doc.text(psiLines, 55, y);
            y += (psiLines.length * 6);
          }
          if (objAfet) {
            doc.setFont("times", "bold");
            doc.text("AFECTIVO:", 20, y);
            doc.setFont("times", "normal");
            const afetLines = doc.splitTextToSize(objAfet, 200);
            doc.text(afetLines, 50, y);
            y += (afetLines.length * 6);
          }
          y += 5;
        }
        
        // --- TABELA ---
        const tableData = [];
        for(let i = 1; i <= 4; i++) {
          tableData.push([
            getVal(`tempo${i}`),
            getVal(`funcao${i}`),
            formatarComHifens(getVal(`conteudo${i}`)),
            formatarComHifens(getVal(`prof${i}`)),
            formatarComHifens(getVal(`aluno${i}`)),
            getVal(`metodo${i}`),
            formatarComHifens(getVal(`meio${i}`))
          ]);
        }
        
        doc.autoTable({
          startY: y,
          head: [['TEMPO', 'FUN√á√ÉO DID√ÅCTICA', 'CONTE√öDOS', 'ACTIVIDADES DO PROFESSOR', 'ACTIVIDADES DO ALUNO', 'M√âTODOS', 'MEIOS']],
          body: tableData,
          styles: { 
            font: "times", 
            fontSize: 12, 
            cellPadding: 2, 
            lineColor: [0,0,0], 
            lineWidth: 0.2, 
            textColor: [0,0,0], 
            valign: 'top', 
            halign: 'left', 
            lineHeight: 1.5 
          },
          headStyles: { 
            fillColor: [224, 231, 255], 
            textColor: [0,0,0], 
            fontStyle: 'bold', 
            fontSize: 12, 
            halign: 'center' 
          },
          columnStyles: { 
            0: { cellWidth: 20 }, 
            1: { cellWidth: 28 }, 
            2: { cellWidth: 40 }, 
            3: { cellWidth: 68 }, 
            4: { cellWidth: 48 }, 
            5: { cellWidth: 34 }, 
            6: { cellWidth: 35 } 
          },
          margin: { left: 15, right: 15 },
          pageBreak: 'auto',
          theme: 'grid',
          showHead: 'firstPage'
        });
        
        // --- QUADRO MURAL (se existir) ---
        if (explicacaoTexto && explicacaoTexto.trim().length > 10) {
          const pageCount = doc.getNumberOfPages();
          let currentPage = pageCount;
          doc.setPage(currentPage);
          const pageHeight = doc.internal.pageSize.height;
          let yPosition = doc.autoTable.previous.finalY + 8;
          
          if (pageHeight - yPosition < 30) {
            doc.addPage({ orientation: "landscape", unit: "mm", format: "a4" });
            currentPage = doc.getNumberOfPages();
            doc.setPage(currentPage);
            yPosition = 20;
          }
          
          doc.setFont("times", "bold");
          doc.setFontSize(12);
          doc.text("QUADRO MURAL", 148, yPosition, { align: "center" });
          doc.setFont("times", "normal");
          yPosition += 7;
          
          const lines = doc.splitTextToSize(explicacaoTexto, 260);
          for (let i = 0; i < lines.length; i++) {
            if (yPosition > 190) {
              doc.addPage({ orientation: "landscape", unit: "mm", format: "a4" });
              currentPage = doc.getNumberOfPages();
              doc.setPage(currentPage);
              yPosition = 20;
            }
            doc.text(lines[i], 15, yPosition);
            yPosition += 6;
          }
        }
        
        // Salvar PDF
        const data = dadosPlano.data ? dadosPlano.data.replace(/\//g, '-') : 'sem-data';
        const temaAbreviado = dadosPlano.tema ? dadosPlano.tema.substring(0,20).replace(/[^\w\s]/gi,'').replace(/\s+/g,'_') : 'sem-tema';
        doc.save(`Plano_Aula_${data}_${temaAbreviado}.pdf`);
        
        alert("‚úÖ PDF gerado com sucesso!");
      } catch (error) {
        alert("‚ùå Erro ao gerar PDF: " + error.message);
        console.error(error);
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const validations = [
        { id: 'classe', fn: (e) => apenasDigitosMax(e.target, 2) },
        { id: 'turma', fn: (e) => apenasLetraUnica(e.target) },
        { id: 'numAlunos', fn: (e) => apenasDigitosMax(e.target) },
        { id: 'numLicao', fn: (e) => apenasDigitosMax(e.target) },
        { id: 'periodo', fn: (e) => apenasLetras(e.target) },
        { id: 'escola', fn: (e) => apenasLetras(e.target) },
        { id: 'professor', fn: (e) => apenasLetras(e.target) },
        { id: 'disciplina', fn: (e) => apenasLetras(e.target) },
        { id: 'unidade', fn: (e) => letrasENumeros(e.target) },
        { id: 'tema', fn: (e) => temaPermitido(e.target) },
        { id: 'tipoAula', fn: (e) => apenasLetras(e.target) }
      ];

      validations.forEach(v => {
        const el = document.getElementById(v.id);
        if (el) el.addEventListener('input', v.fn);
      });

      const savedData = sessionStorage.getItem("dadosPlano");
      if (savedData) {
        dadosPlano = JSON.parse(savedData);
        Object.keys(dadosPlano).forEach(key => {
          const el = document.getElementById(key);
          if (el) el.value = dadosPlano[key] || '';
        });
      }
    });
  </script>
</body>
</html>